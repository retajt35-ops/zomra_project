<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø²Ù…Ø±Ø© | Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø¯Ù…</title>

  <!-- Ø®Ø·ÙˆØ· ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --primary-red:#B30000;--burgundy-dark:#800020;--primary-text:#333;--secondary-text:#666;
      --background-light:#F8F8F8;--card-background:#FFF;
      --gradient-hospital-btn:linear-gradient(to left,#A52A2A,#C04000);
      --gradient-urgent-btn:linear-gradient(to left,#800020,#B30000);
      --gradient-map-btn:linear-gradient(to left,#A52A2A,#C04000);
      --gradient-whatsapp-btn:linear-gradient(to left,#25D366,#3EDF7D);
      --gradient-header:linear-gradient(to right,#fff,#F4F4F4);
      --gradient-send:linear-gradient(to right,var(--burgundy-dark),var(--primary-red));
      --bot-bubble:#EBF2F7;--user-bubble:var(--primary-red);
      --shadow-subtle:0 4px 12px rgba(0,0,0,.08);
      --border-radius-lg:12px;--border-radius-sm:6px;
      --critical-red:#DC3545;--high-yellow:#FFC107;--low-blue:#17A2B8;
    }
    body{
      font-family:'Tajawal',sans-serif;
      background:var(--background-light);
      margin:0;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      padding:20px;
      box-sizing:border-box;
      color:var(--primary-text);
    }

    /* ØªØ®Ø·ÙŠØ· Ø¹Ø§Ù… */
    .main-wrapper{
      display:flex;
      width:100%;
      max-width:1300px;
      gap:25px;
      height:100%;
    }

    /* Ø§Ù†Ø¹ÙƒØ§Ø³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
    body.rtl .main-wrapper{flex-direction:row-reverse;}
    body.ltr .main-wrapper{flex-direction:row;}

    .chat-container{
      flex:3;
      background:var(--card-background);
      border-radius:var(--border-radius-lg);
      box-shadow:var(--shadow-subtle);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      height:calc(100vh - 40px);
      min-height:700px;
    }
    .sidebar-container{
      flex:1.2;
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    .sidebar-box{
      background:var(--card-background);
      border-radius:var(--border-radius-lg);
      box-shadow:var(--shadow-subtle);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:15px;
    }
    .sidebar-box h2{
      color:var(--burgundy-dark);
      font-size:1.3em;
      font-weight:800;
      margin:0;
      padding-bottom:10px;
      border-bottom:2px solid #EEE;
    }

    .sidebar-btn{
      display:flex;
      align-items:center;
      gap:15px;
      padding:15px;
      border-radius:var(--border-radius-sm);
      text-decoration:none;
      color:#fff;
      transition:all .2s;
      border:none;
      cursor:pointer;
      min-height:60px;
      box-shadow:0 4px 8px rgba(0,0,0,.15);
    }

    body.rtl .sidebar-btn{flex-direction:row-reverse;}
    body.ltr .sidebar-btn{flex-direction:row;}

    .sidebar-btn.hospital{background-image:var(--gradient-hospital-btn)}
    .sidebar-btn.urgent{background-image:var(--gradient-urgent-btn)}
    .sidebar-btn.map{background-image:var(--gradient-map-btn)}
    .sidebar-btn.whatsapp{background-image:var(--gradient-whatsapp-btn)}
    .sidebar-btn .icon{font-size:1.8em;color:#fff;font-weight:900}
    .sidebar-btn .label{font-weight:700;font-size:1em;flex-grow:1;}
    body.rtl .sidebar-btn .label{text-align:right;}
    body.ltr .sidebar-btn .label{text-align:left;}

    header{
      background:var(--gradient-header);
      padding:20px;
      border-bottom:1px solid #E0E0E0;
    }

    body.rtl header{text-align:right;}
    body.ltr header{text-align:left;}

    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    body.rtl .header-top{flex-direction:row-reverse;}
    body.ltr .header-top{flex-direction:row;}

    header h1{
      font-size:1.6em;
      margin:0;
      color:var(--burgundy-dark);
      font-weight:800;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .lang-toggle-btn{
      border:none;
      padding:8px 14px;
      border-radius:999px;
      background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
      cursor:pointer;
      font-weight:700;
      font-size:.9em;
      min-width:80px;
    }
    .lang-toggle-btn:hover{background:#f3f3f3;}

    #chat-box{
      flex-grow:1;
      padding:20px 25px;
      overflow-y:auto;
      background:#FAFAFA;
      display:flex;
      flex-direction:column;
    }

    .message{
      padding:14px 20px;
      margin-bottom:15px;
      border-radius:var(--border-radius-lg);
      max-width:70%;
      line-height:1.7;
      font-size:.95em;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    .bot-message{
      background:var(--bot-bubble);
      align-self:flex-start;
      border-bottom-left-radius:var(--border-radius-sm);
    }
    .user-message{
      background:var(--user-bubble);
      color:#fff;
      align-self:flex-end;
      border-bottom-right-radius:var(--border-radius-sm);
    }
    .loading-message{font-weight:700;color:var(--secondary-text);background:#F0F0F0}
    .error-message{color:#666;font-weight:700}

    .input-area{
      display:flex;
      align-items:center;
      padding:15px 20px;
      border-top:1px solid #E0E0E0;
      background:var(--card-background);
      flex-shrink:0;
      gap:8px;
    }
    #user-input{
      flex-grow:1;
      padding:12px 18px;
      border:2px solid var(--primary-red);
      border-radius:var(--border-radius-lg);
      font-size:1em;
      outline:none;
      transition:border-color .2s;
    }
    #user-input:focus{border-color:var(--burgundy-dark)}
    #send-btn{
      background:var(--gradient-send);
      color:#fff;
      border:none;
      padding:12px 24px;
      border-radius:var(--border-radius-lg);
      cursor:pointer;
      font-size:1em;
      font-weight:700;
      transition:opacity .2s;
    }
    #send-btn:hover:not(:disabled){opacity:.9}
    #send-btn:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body class="rtl">

  <div class="main-wrapper">
    <div class="chat-container">

      <!-- =======================
           Ø§Ù„Ù‡ÙŠØ¯Ø± + Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
      ======================== -->
      <header>
        <div class="header-top">
          <h1 id="header-title">Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø²Ù…Ø±Ø© <span class="blood-drop">ğŸ©¸</span></h1>

          <button id="lang-toggle" class="lang-toggle-btn">
            English
          </button>
        </div>
      </header>

      <!-- =======================
           ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
      ======================== -->
      <div id="chat-box">

        <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
        <div class="message bot-message" id="welcome-message">

          <div class="welcome-main" id="welcome-main-text">
            Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong style="color:var(--primary-red);font-weight:800;">Ø²Ù…Ø±Ø©</strong>
            â€” Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ø¤Ø§Ù„ Ø¹Ù† <strong>Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</strong>.
          </div>

          <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø© -->
          <div class="translation-block">
            <button class="toggle-btn" onclick="toggleNext(this)">
              Show English translation
            </button>

            <div class="ar-translation"
                 style="display:none;margin-top:6px;direction:ltr;text-align:left;">
              Welcome to <strong style="color:#B30000;font-weight:800;">Zomrah</strong>
              â€” start by asking about <strong>donation eligibility</strong>.
            </div>
          </div>

        </div>
      </div>

      <!-- =======================
           Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      ======================== -->
      <div class="input-area">
        <button id="mic-btn" type="button" title="Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØªÙŠ">
          <i class="fas fa-microphone"></i>
        </button>

        <input type="file" id="audio-input" accept="audio/*" style="display:none" />

        <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." autofocus />

        <button id="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>

    </div> <!-- Ù†Ù‡Ø§ÙŠØ© chat-container -->
    <!-- =======================
         Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Sidebar)
    ======================== -->
    <div class="sidebar-container">

      <!-- Ø®Ø±ÙŠØ·Ø© Ø¬Ø¯Ø© -->
      <div class="sidebar-box map-widget"
           style="padding:0;overflow:hidden;border-radius:12px;">

        <div id="mapid" style="height:220px;"></div>

        <button class="sidebar-btn hospital"
                id="locate-center-btn"
                style="border-radius:0;margin:0;width:100%;">
          <i class="fas fa-map-pin icon" style="font-size:1.4em;"></i>
          <span class="label" id="locate-center-label">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ ÙˆØ£Ø¸Ù‡Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ²</span>
        </button>

        <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
        <div class="map-filters">
          <input id="map-search" type="text"
                 placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ø§Ù„Ø­ÙŠ..." />

          <select id="map-sector">
            <option value="">Ø§Ù„Ù‚Ø·Ø§Ø¹: Ø§Ù„ÙƒÙ„</option>
            <option value="public">Ø­ÙƒÙˆÙ…ÙŠ ÙÙ‚Ø·</option>
            <option value="private">Ø®Ø§Øµ ÙÙ‚Ø·</option>
          </select>

          <button id="map-apply" class="helper-btn">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="map-reset" class="helper-btn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>

          <button id="map-nearest" class="go-map-btn">Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„Ø¢Ù†</button>

          <div class="counter" id="map-counter">â€”</div>
        </div>

      </div>

      <!-- Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ -->
      <button class="sidebar-btn urgent" id="urgent-needs-btn">
        <i class="fas fa-exclamation-triangle icon"></i>
        <span class="label" id="urgent-label">Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ Ù„Ù„Ø¯Ù…</span>
      </button>

      <!-- ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ© -->
      <button class="sidebar-btn map" id="eligibility-flow-btn">
        <i class="fas fa-clipboard-check icon"></i>
        <span class="label" id="eligibility-label">ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</span>
      </button>

      <!-- Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ¨Ø±Ø¹ -->
      <button class="sidebar-btn map" id="reminder-btn">
        <i class="fas fa-bell icon"></i>
        <span class="label" id="reminder-label">ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ¨Ø±Ø¹</span>
      </button>

      <!-- ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø§Ù„Ù„ØºØªÙŠÙ† -->
      <a class="sidebar-btn whatsapp"
         target="_blank"
         rel="noopener"
         href="https://wa.me/966504635135?text=Ø£Ù‡Ù„Ø§Ù‹ØŒ%20Ø£ÙˆØ¯%20Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±%20Ø¹Ù†%20Ø®Ø¯Ù…Ø©%20Ø²Ù…Ø±Ø©.%0AHello,%20I'd%20like%20to%20ask%20about%20the%20Zomrah%20service.">

        <i class="fab fa-whatsapp icon"></i>
        <span class="label" id="whatsapp-label">
          ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± (ÙˆØ§ØªØ³Ø§Ø¨)
        </span>
      </a>

      <!-- Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© -->
      <div class="sidebar-box">
        <h2 id="faq-title">â“ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø´Ø§Ø¦Ø¹Ø©</h2>

        <div class="faq-list">
          <div class="faq-item" id="faq-1"
               onclick="sendQuickQuestion('Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ')">
            Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          </div>

          <div class="faq-item" id="faq-2"
               onclick="sendQuickQuestion('Ù…ØªÙ‰ Ø£Ù‚Ø¯Ø± Ø£ØªØ¨Ø±Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ')">
            Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø¨ÙŠÙ† Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª
          </div>

          <div class="faq-item" id="faq-3"
               onclick="sendQuickQuestion('Ù‡Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù… Ù…Ø¤Ù„Ù…ØŸ')">
            Ø§Ù„Ø¢Ø«Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ù…Ø®Ø§ÙˆÙ
          </div>

          <div class="faq-item" id="faq-4"
               onclick="sendQuickQuestion('Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ')">
            Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø±Ø¹
          </div>

          <div class="faq-item" id="faq-5"
               onclick="sendQuickQuestion('Ù‡Ù„ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¥Ø°Ø§ Ø¹Ù†Ø¯ÙŠ Ù…Ø±Ø¶ Ù…Ø²Ù…Ù†ØŸ')">
            Ø§Ù„ØªØ¨Ø±Ø¹ Ù…Ø¹ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©
          </div>
        </div>

      </div>

    </div> <!-- Ù†Ù‡Ø§ÙŠØ© sidebar-container -->
<script>
  // =======================
  // Ù†Ø¸Ø§Ù… Ø§Ù„Ù„ØºØ© + Ø¹ÙƒØ³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
  // =======================

  let CURRENT_LANG = "ar";

  function applyLanguage() {

    // -----------------------
    // 1) Ø¹ÙƒØ³ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø© ÙƒÙ„ÙŠØ§Ù‹
    // -----------------------
    document.documentElement.lang = CURRENT_LANG;
    document.documentElement.dir = CURRENT_LANG === "ar" ? "rtl" : "ltr";

    const body = document.body;
    if (CURRENT_LANG === "ar") {
      body.classList.remove("ltr");
      body.classList.add("rtl");
    } else {
      body.classList.remove("rtl");
      body.classList.add("ltr");
    }

    // -----------------------
    // 2) ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
    
    const headerTitle = document.getElementById("header-title");
    if (headerTitle) {
      headerTitle.innerHTML =
        CURRENT_LANG === "ar"
          ? 'Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø²Ù…Ø±Ø© <span class="blood-drop">ğŸ©¸</span>'
          : 'Chat with Zomrah <span class="blood-drop">ğŸ©¸</span>';
    }

    // -----------------------
    // 3) Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
    // -----------------------
    const langBtn = document.getElementById("lang-toggle");
    if (langBtn) {
      langBtn.textContent = CURRENT_LANG === "ar" ? "English" : "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
      langBtn.title =
        CURRENT_LANG === "ar"
          ? "Switch interface to English"
          : "ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
    }

    // -----------------------
    // 4) Ø§Ù„Ø­Ù‚ÙˆÙ„ Ùˆ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    // -----------------------
    const input = document.getElementById("user-input");
    if (input) {
      input.placeholder =
        CURRENT_LANG === "ar"
          ? "Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."
          : "Type your question here...";
    }

    const sendBtn = document.getElementById("send-btn");
    if (sendBtn) {
      sendBtn.textContent = CURRENT_LANG === "ar" ? "Ø¥Ø±Ø³Ø§Ù„" : "Send";
    }

    const locateLbl = document.getElementById("locate-center-label");
    if (locateLbl) {
      locateLbl.textContent =
        CURRENT_LANG === "ar"
          ? "Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ ÙˆØ£Ø¸Ù‡Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ²"
          : "Locate me and show centers";
    }

    const urgentLbl = document.getElementById("urgent-label");
    if (urgentLbl) {
      urgentLbl.textContent =
        CURRENT_LANG === "ar"
          ? "Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ Ù„Ù„Ø¯Ù…"
          : "Urgent blood needs";
    }

    const eligLbl = document.getElementById("eligibility-label");
    if (eligLbl) {
      eligLbl.textContent =
        CURRENT_LANG === "ar" ? "ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©" : "Check eligibility";
    }

    const remLbl = document.getElementById("reminder-label");
    if (remLbl) {
      remLbl.textContent =
        CURRENT_LANG === "ar" ? "ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ¨Ø±Ø¹" : "Donation reminder";
    }

    const waLbl = document.getElementById("whatsapp-label");
    if (waLbl) {
      waLbl.textContent =
        CURRENT_LANG === "ar" ? "ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± (ÙˆØ§ØªØ³Ø§Ø¨)" : "Contact us (WhatsApp)";
    }

    // -----------------------
    // 5) ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
    // -----------------------
    const faqTitle = document.getElementById("faq-title");
    if (faqTitle) {
      faqTitle.textContent =
        CURRENT_LANG === "ar" ? "â“ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø´Ø§Ø¦Ø¹Ø©" : "â“ Common questions";
    }

    // -----------------------
    // 6) ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¦Ù„Ø© Ù‚Ø§Ø¦Ù…Ø© FAQ
    // -----------------------

    function setFAQ(id, ar, en, arQ, enQ) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = CURRENT_LANG === "ar" ? ar : en;
      el.setAttribute(
        "onclick",
        CURRENT_LANG === "ar"
          ? `sendQuickQuestion('${arQ}')`
          : `sendQuickQuestion('${enQ}')`
      );
    }

    setFAQ("faq-1", "Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", "Basic donation requirements",
      "Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ",
      "What are the conditions for blood donation?");

    setFAQ("faq-2", "Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø¨ÙŠÙ† Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª", "Time between donations",
      "Ù…ØªÙ‰ Ø£Ù‚Ø¯Ø± Ø£ØªØ¨Ø±Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ",
      "When can I donate again?");

    setFAQ("faq-3", "Ø§Ù„Ø¢Ø«Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ù…Ø®Ø§ÙˆÙ", "Side effects & concerns",
      "Ù‡Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù… Ù…Ø¤Ù„Ù…ØŸ",
      "Is blood donation painful?");

    setFAQ("faq-4", "Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø±Ø¹", "How to prepare before donation",
      "Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ",
      "What should I do before donating blood?");

    setFAQ("faq-5", "Ø§Ù„ØªØ¨Ø±Ø¹ Ù…Ø¹ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©", "Donation with chronic diseases",
      "Ù‡Ù„ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¥Ø°Ø§ Ø¹Ù†Ø¯ÙŠ Ù…Ø±Ø¶ Ù…Ø²Ù…Ù†ØŸ",
      "Can I donate if I have a chronic disease?");

    // -----------------------
    // 7) Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
    // -----------------------
    const welcome = document.getElementById("welcome-message");
    if (welcome) {
      const mainDiv = document.getElementById("welcome-main-text");
      const transDiv = welcome.querySelector(".ar-translation");
      const transBtn = welcome.querySelector(".toggle-btn");

      if (CURRENT_LANG === "ar") {
        mainDiv.innerHTML =
          'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong style="color:var(--primary-red);font-weight:800;">Ø²Ù…Ø±Ø©</strong> â€” Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ø¤Ø§Ù„ Ø¹Ù† <strong>Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</strong>.';

        transBtn.textContent = "Show English translation";
        transDiv.style.direction = "ltr";
        transDiv.style.textAlign = "left";
        transDiv.innerHTML =
          'Welcome to <strong style="color:#B30000;font-weight:800;">Zomrah</strong> â€” start by asking about <strong>donation eligibility</strong>.';

      } else {
        mainDiv.innerHTML =
          'Welcome to <strong style="color:#B30000;font-weight:800;">Zomrah</strong> â€” start by asking about <strong>donation eligibility</strong>.';

        transBtn.textContent = "Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
        transDiv.style.direction = "rtl";
        transDiv.style.textAlign = "right";
        transDiv.innerHTML =
          'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong style="color:var(--primary-red);font-weight:800;">Ø²Ù…Ø±Ø©</strong> â€” Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ø¤Ø§Ù„ Ø¹Ù† <strong>Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</strong>.';
      }
    }
  }

  // --------------------------
  // Ø­Ø¯Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù„ØºØ©
  // --------------------------
  document.addEventListener("DOMContentLoaded", function () {
    const langBtn = document.getElementById("lang-toggle");
    if (langBtn) {
      langBtn.addEventListener("click", function () {
        CURRENT_LANG = CURRENT_LANG === "ar" ? "en" : "ar";
        applyLanguage();
      });
    }
    applyLanguage();
  });

</script>
/* ====================================================
     Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Ù…Ø³ â€” Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ + Ù…Ù‡Ù„Ø© 5 Ø«ÙˆØ§Ù†Ù
==================================================== */

async function processChatResponse(rawMessage) {

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    displayMessage(rawMessage, "user");

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© "Ø²Ù…Ø±Ø© ØªÙƒØªØ¨..."
    let loadingDiv = showLoading();

    try {

        // ØªØ·Ø¨ÙŠÙ‚ Ù…Ù‡Ù„Ø© 5 Ø«ÙˆØ§Ù†Ù Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø¯
        await new Promise(resolve => setTimeout(resolve, 5000));

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯
        const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                message: rawMessage,
                lang: CURRENT_LANG
            })
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        removeLoading(loadingDiv);

        let answerText = (data.answer || "").trim();

        /* ------------------------------------------
           Ù„Ùˆ Ø§Ù„Ø±Ø¯ ÙØ§Ø±Øº Ø£Ùˆ Ù‚ØµÙŠØ± â†’ Ù†Ø³ØªØ®Ø¯Ù… Ø±Ø³Ø§Ù„Ø© fallback
        ------------------------------------------- */
        if (!answerText || answerText.length < 10) {

            const fallbackPrefix =
                CURRENT_LANG === "ar"
                    ? "Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©Ø› Ø§Ø³ØªØ¹Ù†Ø§ Ø¨Ù€ OpenAI Ù„ØµÙŠØ§ØºØ© Ø§Ù„Ø±Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ:"
                    : "No answer was found in the knowledge base; we used OpenAI to generate the following reply:";

            const fallbackDetail =
                CURRENT_LANG === "ar"
                    ? "Ù„Ù… Ø£Ø³ØªØ·Ø¹ ÙÙ‡Ù… Ø³Ø¤Ø§Ù„Ùƒ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„. Ø­Ø§ÙˆÙ„ ÙƒØªØ§Ø¨ØªÙ‡ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£Ø¨Ø³Ø· Ø£Ùˆ Ø£ÙƒØ«Ø± ØªØ­Ø¯ÙŠØ¯Ù‹Ø§."
                    : "I couldn't fully understand your question. Please try asking in simpler or more specific words.";

            const footerAI =
                CURRENT_LANG === "ar"
                    ? "Ù…ÙÙˆÙ„Ù‘ÙØ¯ Ø¢Ù„ÙŠÙ‹Ø§ â€¢ Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø®Ø·Ø§Ø¡ Ø·ÙÙŠÙØ©<br>Ù…Ø¹ ØªØ­ÙŠØ§Øª ÙØ±ÙŠÙ‚ Ø²Ù…Ø±Ø© ğŸ©¸"
                    : "AI-generated â€¢ may contain minor errors<br>With regards, Zomrah Team ğŸ©¸";

            const finalMessage =
                `${fallbackPrefix}<br><br>${fallbackDetail}<br><br><span style="font-size:0.85em;color:#666">${footerAI}</span>`;

            displayAnswerWithControls(finalMessage, rawMessage);
            return;
        }

        /* ------------------------------------------
             Ù„Ùˆ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
        ------------------------------------------- */
        const prefix =
            CURRENT_LANG === "ar"
                ? "ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©:"
                : "An answer was found in the knowledge base:";

        const footerAI =
            CURRENT_LANG === "ar"
                ? "Ù…ÙÙˆÙ„Ù‘ÙØ¯ Ø¢Ù„ÙŠÙ‹Ø§ â€¢ Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø®Ø·Ø§Ø¡ Ø·ÙÙŠÙØ©<br>Ù…Ø¹ ØªØ­ÙŠØ§Øª ÙØ±ÙŠÙ‚ Ø²Ù…Ø±Ø© ğŸ©¸"
                : "AI-generated â€¢ may contain minor errors<br>With regards, Zomrah Team ğŸ©¸";

        const finalAnswer =
            `${prefix}<br><br>${answerText}<br><br><span style="font-size:0.85em;color:#666">${footerAI}</span>`;

        displayAnswerWithControls(finalAnswer, rawMessage);

    } catch (err) {
        removeLoading(loadingDiv);
        displayError(
            CURRENT_LANG === "ar"
                ? "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯."
                : "An error occurred while processing the response."
        );
    }
}
/* ====================================================
     Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³Ø§Ø¯Ø³ â€” Ø¯Ø¹Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
==================================================== */

const micBtn = document.getElementById('mic-btn');
const audioInput = document.getElementById('audio-input');

let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

/* Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù ØµÙˆØªÙŠ Ù„Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯ */
async function sendAudioBlob(blob, filename) {

    const loading = showLoading();

    try {
        await new Promise(resolve => setTimeout(resolve, 5000)); // Ù…Ù‡Ù„Ø© 5 Ø«ÙˆØ§Ù†Ù Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø¯

        const fd = new FormData();
        fd.append('audio_file', blob, filename);

        const res = await fetch('/api/upload_audio', {
            method: 'POST',
            body: fd
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();
        removeLoading(loading);

        displayMessage(
            CURRENT_LANG === "ar" ? "ğŸ™ï¸ (Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©)" : "ğŸ™ï¸ (voice message)",
            "user"
        );

        const footerAI =
            CURRENT_LANG === "ar"
                ? "Ù…ÙÙˆÙ„Ù‘ÙØ¯ Ø¢Ù„ÙŠÙ‹Ø§ â€¢ Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø®Ø·Ø§Ø¡ Ø·ÙÙŠÙØ©<br>Ù…Ø¹ ØªØ­ÙŠØ§Øª ÙØ±ÙŠÙ‚ Ø²Ù…Ø±Ø© ğŸ©¸"
                : "AI-generated â€¢ may contain minor errors<br>With regards, Zomrah Team ğŸ©¸";

        const finalText =
            `${data.answer}<br><br><span style="font-size:0.85em;color:#666">${footerAI}</span>`;

        displayAnswerWithControls(finalText, data.transcribed_text || "");

    } catch (e) {
        removeLoading(loading);

        displayError(
            CURRENT_LANG === "ar"
                ? "ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙˆØªÙŠØ©."
                : "Failed to process audio."
        );
    }
}


/* Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ */
micBtn.addEventListener('click', async function () {

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {

        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    sendAudioBlob(blob, "mic_recording.webm");
                    stream.getTracks().forEach(t => t.stop());
                };

                mediaRecorder.start();
                isRecording = true;

                micBtn.classList.add("recording");
                micBtn.title = CURRENT_LANG === "ar" ? "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„" : "Stop recording";

            } catch (err) {
                audioInput.click();
            }

        } else {
            isRecording = false;
            micBtn.classList.remove("recording");
            micBtn.title = CURRENT_LANG === "ar" ? "Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØªÙŠ" : "Send audio";

            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
        }

    } else {
        audioInput.click();
    }
});


/* Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØªÙŠ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² */
audioInput.addEventListener('change', async function () {

    if (!this.files || !this.files.length) return;

    const file = this.files[0];
    const loading = showLoading();

    try {
        await new Promise(resolve => setTimeout(resolve, 5000)); // Ù…Ù‡Ù„Ø© 5 Ø«ÙˆØ§Ù†Ù

        const fd = new FormData();
        fd.append('audio_file', file);

        const res = await fetch('/api/upload_audio', {
            method: 'POST',
            body: fd
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();
        removeLoading(loading);

        displayMessage(
            CURRENT_LANG === "ar"
                ? `ğŸ™ï¸ (${file.name || "Ù…Ù„Ù ØµÙˆØªÙŠ"})`
                : `ğŸ™ï¸ (${file.name || "audio file"})`,
            "user"
        );

        const footerAI =
            CURRENT_LANG === "ar"
                ? "Ù…ÙÙˆÙ„Ù‘ÙØ¯ Ø¢Ù„ÙŠÙ‹Ø§ â€¢ Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø®Ø·Ø§Ø¡ Ø·ÙÙŠÙØ©<br>Ù…Ø¹ ØªØ­ÙŠØ§Øª ÙØ±ÙŠÙ‚ Ø²Ù…Ø±Ø© ğŸ©¸"
                : "AI-generated â€¢ may contain minor errors<br>With regards, Zomrah Team ğŸ©¸";

        const finalAnswer =
            `${data.answer}<br><br><span style="font-size:0.85em;color:#666">${footerAI}</span>`;

        displayAnswerWithControls(finalAnswer, data.transcribed_text || "");

    } catch (e) {
        removeLoading(loading);

        displayError(
            CURRENT_LANG === "ar"
                ? "ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ."
                : "Failed to upload audio file."
        );

    } finally {
        this.value = '';
    }
});
    </script>

</body>
</html>
