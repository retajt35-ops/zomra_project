<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø²Ù…Ø±Ø© | Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø¯Ù…</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --primary-red:#B30000;--burgundy-dark:#800020;--primary-text:#333;--secondary-text:#666;
      --background-light:#F8F8F8;--card-background:#FFF;
      --gradient-hospital-btn:linear-gradient(to left,#A52A2A,#C04000);
      --gradient-urgent-btn:linear-gradient(to left,#800020,#B30000);
      --gradient-map-btn:linear-gradient(to left,#A52A2A,#C04000);
      --gradient-whatsapp-btn:linear-gradient(to left,#25D366,#3EDF7D);
      --gradient-header:linear-gradient(to right,#fff,#F4F4F4);
      --gradient-send:linear-gradient(to right,var(--burgundy-dark),var(--primary-red));
      --bot-bubble:#EBF2F7;--user-bubble:var(--primary-red);
      --shadow-subtle:0 4px 12px rgba(0,0,0,.08);
      --border-radius-lg:12px;--border-radius-sm:6px;
      --critical-red:#DC3545;--high-yellow:#FFC107;--low-blue:#17A2B8;
    }
    body{font-family:'Tajawal',sans-serif;background:var(--background-light);margin:0;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px;box-sizing:border-box;color:var(--primary-text)}
    .main-wrapper{display:flex;flex-direction:row-reverse;width:100%;max-width:1300px;gap:25px;height:100%}
    .chat-container{flex:3;background:var(--card-background);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-subtle);display:flex;flex-direction:column;overflow:hidden;height:calc(100vh - 40px);min-height:700px}
    .sidebar-container{flex:1.2;display:flex;flex-direction:column;gap:20px}
    .sidebar-box{background:var(--card-background);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-subtle);padding:20px;display:flex;flex-direction:column;gap:15px}
    .sidebar-box h2{color:var(--burgundy-dark);font-size:1.3em;font-weight:800;margin:0;padding-bottom:10px;border-bottom:2px solid #EEE}
    .sidebar-btn{display:flex;flex-direction:row-reverse;align-items:center;gap:15px;padding:15px;border-radius:var(--border-radius-sm);text-decoration:none;color:#fff;transition:all .2s;border:none;cursor:pointer;min-height:60px;box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .sidebar-btn.hospital{background-image:var(--gradient-hospital-btn)}
    .sidebar-btn.urgent{background-image:var(--gradient-urgent-btn)}
    .sidebar-btn.map{background-image:var(--gradient-map-btn)}
    .sidebar-btn.whatsapp{background-image:var(--gradient-whatsapp-btn)}
    .sidebar-btn .icon{font-size:1.8em;color:#fff;font-weight:900}
    .sidebar-btn .label{font-weight:700;font-size:1em;flex-grow:1;text-align:right}
    .sidebar-btn:hover:not(:disabled){transform:scale(1.02);opacity:.9;box-shadow:0 8px 16px rgba(0,0,0,.25)}
    .sidebar-btn:disabled{cursor:not-allowed;opacity:.6}

    header{background:var(--gradient-header);padding:20px;border-bottom:1px solid #E0E0E0;text-align:right}
    header h1{font-size:1.6em;margin:0;color:var(--burgundy-dark);font-weight:800;display:flex;align-items:center;flex-direction:row-reverse;justify-content:flex-end;gap:10px}

    #chat-box{flex-grow:1;padding:20px 25px;overflow-y:auto;background:#FAFAFA;display:flex;flex-direction:column}

    .message{padding:14px 20px;margin-bottom:15px;border-radius:var(--border-radius-lg);max-width:70%;line-height:1.7;font-size:.95em;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .bot-message{background:var(--bot-bubble);align-self:flex-start;border-bottom-left-radius:var(--border-radius-sm)}
    .user-message{background:var(--user-bubble);color:#fff;align-self:flex-end;border-bottom-right-radius:var(--border-radius-sm)}
    .loading-message{font-weight:700;color:var(--secondary-text);background:#F0F0F0}
    .error-message{color:#666;font-weight:700}

    .input-area{display:flex;padding:15px 20px;border-top:1px solid #E0E0E0;background:var(--card-background);flex-shrink:0}
    #user-input{flex-grow:1;padding:12px 18px;border:2px solid var(--primary-red);border-radius:var(--border-radius-lg);margin-inline-end:10px;font-size:1em;outline:none;transition:border-color .2s}
    #user-input:focus{border-color:var(--burgundy-dark)}
    #send-btn{background:var(--gradient-send);color:#fff;border:none;padding:12px 30px;border-radius:var(--border-radius-lg);cursor:pointer;font-size:1em;font-weight:700;transition:opacity .2s,background .2s}
    #send-btn:hover:not(:disabled){opacity:.9}
    #send-btn:disabled{opacity:.6;cursor:not-allowed}

    .translation-block{margin-top:10px}
    .toggle-btn{margin-top:8px;background:#eee;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:700}
    .helper-btn{margin-top:8px;background:#fff;border:1px solid #ddd;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:700}
    .inline-note{font-size:.9em;color:var(--secondary-text);margin-top:6px}

    .faq-list{display:flex;flex-direction:column;gap:10px}
    .faq-item{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700;transition:transform .15s, background .15s, border-color .15s;user-select:none}
    .faq-item:hover{transform:translateY(-1px);background:#fefefe;border-color:#e2e2e2}

    /* Ø¹Ù†Ø§ØµØ± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù‡Ù„ÙŠØ© */
    .pill{display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:999px;margin:4px;cursor:pointer;font-weight:700;background:#fff}
    .pill.active{background:#B30000;color:#fff;border-color:#B30000}
    .elig-row{margin:8px 0}
    .elig-row label{display:block;margin-bottom:6px;font-weight:800;color:#555}
    .elig-input{padding:8px 10px;border:1px solid #ddd;border-radius:8px;width:100%;max-width:260px;font-family:inherit}
    .elig-result{margin-top:10px;padding:10px;border-radius:10px;border:1px dashed #ddd;background:#fafafa}
    .elig-result.ok{border-color:#3fb950;background:#f1fff3}
    .elig-result.bad{border-color:#d73a49;background:#fff5f5}
    .muted{color:#888}

    /* Ø®Ø±ÙŠØ·Ø© + ÙÙ„Ø§ØªØ± */
    .go-map-btn{
      display:inline-block;margin-top:8px;padding:8px 12px;border-radius:10px;
      background:linear-gradient(to left,#800020,#B30000);color:#fff;text-decoration:none;
      font-weight:800;border:none;box-shadow:0 4px 8px rgba(0,0,0,.15)
    }
    .go-map-btn:hover{opacity:.92;transform:translateY(-1px)}
    .hospital-popup strong{display:block;margin-bottom:6px}
    .details-label{font-weight:700}

    .map-filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:10px;border-top:1px solid #eee;background:#fff}
    .map-filters input,.map-filters select{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-family:inherit}
    .map-filters .counter{font-size:.9em;color:#555;margin-inline-start:auto}
  </style>
</head>
<body>

  <div class="main-wrapper">
    <div class="chat-container">
      <header>
        <h1>Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø²Ù…Ø±Ø© <span class="blood-drop">ğŸ©¸</span></h1>
      </header>

      <div id="chat-box">
        <div class="message bot-message">
          Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong style="color:var(--primary-red);font-weight:800;">Ø²Ù…Ø±Ø©</strong> â€” Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ø¤Ø§Ù„ Ø¹Ù† <strong>Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</strong>.
          <div class="translation-block">
            <button class="toggle-btn" onclick="toggleNext(this)">Show English translation</button>
            <div class="ar-translation" style="display:none;margin-top:6px;direction:ltr;text-align:left;">
              Welcome to <strong style="color:#B30000;font-weight:800;">Zomrah</strong> â€” start by asking about <strong>donation eligibility</strong>.
            </div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." autofocus/>
        <button id="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>

    <div class="sidebar-container">
      <div class="sidebar-box map-widget" style="padding:0;overflow:hidden;border-radius:12px;">
        <div id="mapid" style="height:220px;"></div>
        <button class="sidebar-btn hospital" id="locate-center-btn" style="border-radius:0;margin:0;width:100%;">
          <i class="fas fa-map-pin icon" style="font-size:1.4em;"></i>
          <span class="label">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ ÙˆØ£Ø¸Ù‡Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ²</span>
        </button>

        <!-- âœ… ÙÙ„Ø§ØªØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
        <div class="map-filters">
          <input id="map-search" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ø§Ù„Ø­ÙŠ..." />
          <select id="map-sector">
            <option value="">Ø§Ù„Ù‚Ø·Ø§Ø¹: Ø§Ù„ÙƒÙ„</option>
            <option value="public">Ø­ÙƒÙˆÙ…ÙŠ ÙÙ‚Ø·</option>
            <option value="private">Ø®Ø§Øµ ÙÙ‚Ø·</option>
          </select>
          <button id="map-apply" class="helper-btn">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="map-reset" class="helper-btn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
          <!-- âœ… Ø²Ø± Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„Ø¢Ù† -->
          <button id="map-nearest" class="go-map-btn">Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„Ø¢Ù†</button>
          <div class="counter" id="map-counter">â€”</div>
        </div>
      </div>

      <button class="sidebar-btn urgent" id="urgent-needs-btn">
        <i class="fas fa-exclamation-triangle icon"></i>
        <span class="label">Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ Ù„Ù„Ø¯Ù…</span>
      </button>

      <button class="sidebar-btn map" id="eligibility-flow-btn">
        <i class="fas fa-clipboard-check icon"></i>
        <span class="label">ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</span>
      </button>

      <button class="sidebar-btn map" id="reminder-btn">
        <i class="fas fa-bell icon"></i>
        <span class="label">ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ¨Ø±Ø¹</span>
      </button>

      <a class="sidebar-btn whatsapp" target="_blank" rel="noopener"
         href="https://wa.me/966504635135?text=%D8%A3%D9%87%D9%84%D8%A7%D9%8B%D8%8C%20%D8%A3%D8%B1%D9%8A%D8%AF%20%D8%A7%D9%84%D8%A7%D8%B3%D8%AA%D9%81%D8%B3%D8%A7%D8%B1%20%D8%B9%D9%86%20%D8%AE%D8%AF%D9%85%D8%A9%20%D8%B2%D9%85%D8%B1%D8%A9.">
        <i class="fab fa-whatsapp icon"></i>
        <span class="label">ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± (ÙˆØ§ØªØ³Ø§Ø¨)</span>
      </a>

      <div class="sidebar-box">
        <h2>â“ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø´Ø§Ø¦Ø¹Ø©</h2>
        <div class="faq-list">
          <div class="faq-item" onclick="sendQuickQuestion('Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ')">Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
          <div class="faq-item" onclick="sendQuickQuestion('Ù…ØªÙ‰ Ø£Ù‚Ø¯Ø± Ø£ØªØ¨Ø±Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ')">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø¨ÙŠÙ† Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª</div>
          <div class="faq-item" onclick="sendQuickQuestion('Ù‡Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù… Ù…Ø¤Ù„Ù…ØŸ')">Ø§Ù„Ø¢Ø«Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ù…Ø®Ø§ÙˆÙ</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== 0) Ø­Ø§Ù„Ø© SMTP Ù…Ù† /health ===== */
    let SMTP_READY = false;
    fetch('/health').then(r=>r.json()).then(j=>{ SMTP_READY = !!j.smtp_ready; }).catch(()=>{ SMTP_READY=false; });

    /* ===== 1) Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ===== */
    function toggleNext(btn){
      var el = btn.nextElementSibling;
      if(!el) return;
      var shown = el.style.display !== 'none';
      el.style.display = shown ? 'none' : 'block';
      btn.textContent = shown ? 'Show English translation' : 'Hide English translation';
    }
    function showLoading(){
      var chatBox = document.getElementById('chat-box');
      var loadingDiv = document.createElement('div');
      loadingDiv.className = 'message bot-message loading-message';
      loadingDiv.id = 'loading-indicator';
      loadingDiv.textContent = 'Ø²Ù…Ø±Ø© ØªÙƒØªØ¨... ğŸ§ ';
      chatBox.appendChild(loadingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      return loadingDiv;
    }
    function removeLoading(loadingDiv){ if(loadingDiv && loadingDiv.parentNode){ loadingDiv.parentNode.removeChild(loadingDiv); } }
    function displayMessage(text, sender){
      var chatBox = document.getElementById('chat-box');
      var msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
      msgDiv.textContent = text;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    function displayError(text){
      var chatBox = document.getElementById('chat-box');
      var msgDiv = document.createElement('div');
      msgDiv.className = 'message bot-message';
      msgDiv.innerHTML = '<span class="error-message">'+ text +'</span>';
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    /* ===== 2) ÙÙ‚Ø§Ø¹Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø¯Ø¯ ===== */
    function displayAnswerWithControls(summarizedText, originalQuestion){
      var cb = document.getElementById('chat-box');
      var m = document.createElement('div');
      m.className = 'message bot-message';

      var main = document.createElement('div');
      main.className = 'ar-text';
      main.innerHTML = (summarizedText || '').replace(/\n/g,'<br>');
      m.appendChild(main);

      var btn = document.createElement('button');
      btn.className = 'helper-btn';
      btn.textContent = 'ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±';
      btn.dataset.state = 'collapsed';
      btn.dataset.summarized = summarizedText || '';
      btn.dataset.question = originalQuestion || '';
      m.appendChild(btn);

      var tr = document.createElement('div');
      tr.className = 'translation-block';
      tr.innerHTML =
        '<button class="toggle-btn" onclick="toggleNext(this)">Show English translation</button>'+
        '<div class="ar-translation" style="display:none;margin-top:6px;direction:ltr;text-align:left;">(English translation appears when backend sends it)</div>';
      m.appendChild(tr);

      btn.addEventListener('click', async function(){
        if (this.dataset.state === 'collapsed') {
          if (!this.dataset.detailed) {
            try{
              const res = await fetch('/api/chat', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ message: this.dataset.question || '', detail: true })
              });
              if(!res.ok) throw new Error('HTTP '+res.status);
              const j = await res.json();
              this.dataset.detailed = j.answer || this.dataset.summarized;
            }catch(e){
              displayError('âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„.');
              return;
            }
          }
          main.innerHTML = (this.dataset.detailed || '').replace(/\n/g,'<br>');
          this.textContent = 'Ø¥Ø¸Ù‡Ø§Ø± Ø£Ù‚Ù„';
          this.dataset.state = 'expanded';
        } else {
          main.innerHTML = (this.dataset.summarized || '').replace(/\n/g,'<br>');
          this.textContent = 'ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±';
          this.dataset.state = 'collapsed';
        }
      });

      cb.appendChild(m);
      cb.scrollTop = cb.scrollHeight;
    }

    /* ===== 3) ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªÙØ§Ø¹Ù„ ===== */
    function setInteractionState(enabled){
      ['send-btn','user-input','urgent-needs-btn','locate-center-btn','eligibility-flow-btn','reminder-btn'].forEach(function(id){
        var el = document.getElementById(id);
        if(el){ el.disabled = !enabled; }
      });
      var faq = document.querySelectorAll('.faq-item');
      for(var i=0;i<faq.length;i++){
        faq[i].style.pointerEvents = 'auto';
        faq[i].style.opacity = '1';
        faq[i].style.cursor = 'pointer';
      }
    }

    /* ===== 4) Ù†ÙŠØ© Ø§Ù„Ù…ÙƒØ§Ù†/Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===== */
    const LOCATION_RE = /(Ù…ÙˆÙ‚Ø¹|Ø§Ù„Ù…ÙˆÙ‚Ø¹|Ø£Ù‚Ø±Ø¨|Ù‚Ø±ÙŠØ¨|Ø§Ù„Ø®Ø±Ø§Ø¦Ø·|Ø§Ù„Ø®Ø±ÙŠØ·Ø©|map|nearest|location|directions|ÙˆÙŠÙ†|Ø§Ù‚Ø±Ø¨)/i;
    function isLocationIntent(t){ return LOCATION_RE.test((t||'').trim()); }

    /* ===== 5) Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===== */
    var JEDDAH_LAT = 21.5433, JEDDAH_LNG = 39.1728, DEFAULT_ZOOM = 11;
    var BLOOD_CENTERS = [];
    var FILTERED_CENTERS = [];
    var markersLayer = null;

    function toRad(v){ return v*Math.PI/180; }
    function haversine(lat1,lng1,lat2,lng2){
      const R=6371;
      const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    function gmapsDirections(fromLat,fromLng,toLat,toLng){
      return 'https://www.google.com/maps/dir/?api=1&origin='+fromLat+','+fromLng+'&destination='+toLat+','+toLng+'&travelmode=driving';
    }
    function gmapsLinkByName(name){ return 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(name); }

    function findNearest(from){
      var best=null, bestD=1e9;
      for(var i=0;i<FILTERED_CENTERS.length;i++){
        var c=FILTERED_CENTERS[i];
        var d=haversine(from[0],from[1],c.lat,c.lng);
        if(d<bestD){ bestD=d; best=c; }
      }
      return best;
    }

    function detectSector(name=''){
      const t = (name||'').trim();
      const pub = /(Ø§Ù„Ù…Ù„Ùƒ|Ø§Ù„ØªØ®ØµØµÙŠ|Ø§Ù„Ø¹Ø§Ù…|Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©|Ø§Ù„Ù‚ÙˆØ§Øª|Ø§Ù„Ø­Ø±Ø³|Ù…Ø¬Ù…Ø¹|Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ùƒ|Ø§Ù„Ø«ØºØ±|Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ©)/;
      const pri = /(Ø§Ù„Ø¯ÙƒØªÙˆØ±|ÙÙ‚ÙŠÙ‡|Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ|Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù…ØªØ­Ø¯ÙˆÙ†|Ø§Ù„Ø³Ù„Ø§Ù…Ø©|Ø§Ù„Ù…ØºØ±Ø¨ÙŠ|Ø§Ù„Ø­ÙŠØ§Ø©|Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø¯ÙˆÙ„ÙŠ|Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø¯ÙˆÙ„ÙŠ|Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ø§Ù„Ù…Ø§Ù†ÙŠ)/;
      if (pub.test(t)) return 'public';
      if (pri.test(t)) return 'private';
      return '';
    }

    function createPopupContent(c){
      var link = gmapsLinkByName(c.name);
      var phoneHtml = c.phone ? ('<p><span class="details-label">ğŸ“ Ø§Ù„ØªÙˆØ§ØµÙ„:</span> <a href="tel:'+c.phone+'" style="color:#0b7dda">'+c.phone+'</a></p>') : '<p><span class="details-label">ğŸ“ Ø§Ù„ØªÙˆØ§ØµÙ„:</span> â€”</p>';
      var hoursHtml = '<p><span class="details-label">â±ï¸ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„:</span> '+(c.hours||'â€”')+'</p>';
      return ''+
        '<div class="hospital-popup">'+
          '<strong><i class="fas fa-hospital-alt"></i> '+ c.name +'</strong>'+
          '<p><span class="details-label">ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span> '+ (c.address||'â€”') +'</p>'+
            hoursHtml + phoneHtml +
          '<a class="go-map-btn" href="'+ link +'" target="_blank" rel="noopener"><i class="fas fa-route"></i> Ø§Ø¶ØºØ· Ù„Ù„ØªÙˆØ¬ÙŠÙ‡</a>'+
        '</div>';
    }

    var map = L.map('mapid').setView([JEDDAH_LAT, JEDDAH_LNG], DEFAULT_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap contributors'}).addTo(map);
    var redMarker = L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});
    var blueMarker = L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});

    function renderCenters(list){
      if (markersLayer){ markersLayer.clearLayers(); map.removeLayer(markersLayer); }
      markersLayer = L.layerGroup();
      (list||[]).forEach(function(c){
        L.marker([c.lat,c.lng],{icon:redMarker}).bindPopup(createPopupContent(c)).addTo(markersLayer);
      });
      markersLayer.addTo(map);
      document.getElementById('map-counter').textContent = list.length ? (list.length + ' Ù†ØªÙŠØ¬Ø©') : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬';
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ²
    fetch('/static/centers_jeddah.json')
      .then(r=>r.json())
      .then(list=>{
        BLOOD_CENTERS = list.map(c=>{
          if (!c.sector){ c.sector = (c.type || detectSector(c.name)); }
          return c;
        });
        FILTERED_CENTERS = BLOOD_CENTERS.slice();
        renderCenters(FILTERED_CENTERS);
      })
      .catch(()=>{ displayError('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ².'); });

    var userLocation = null;

    document.getElementById('locate-center-btn').addEventListener('click', function(){
      var btn = document.getElementById('locate-center-btn');
      btn.disabled = true; btn.querySelector('.label').innerText = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...';
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){
          var userLat = pos.coords.latitude, userLng = pos.coords.longitude;
          userLocation = [userLat, userLng];
          L.marker(userLocation,{icon:blueMarker}).addTo(map).bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ').openPopup();
          map.setView(userLocation, 13);
          btn.querySelector('.label').innerText = 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­';
          btn.disabled = false;
          displayMessage('ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ.','bot');
        }, function(){
          btn.querySelector('.label').innerText = 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø¹Ø±Ø¶ Ø¬Ø¯Ø©)';
          btn.disabled = false;
          displayError('âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ. ÙŠØ±Ø¬Ù‰ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„Ù…ØªØµÙØ­.');
        }, {enableHighAccuracy:true,timeout:10000,maximumAge:0});
      }else{
        btn.querySelector('.label').innerText = 'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
        btn.disabled = false;
        displayError('âŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø§ØµÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.');
      }
    });

    function openNearestAuto(){
      function go(fromLat, fromLng){
        if (!FILTERED_CENTERS.length){ displayError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§ÙƒØ² Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.'); return; }
        var n = findNearest([fromLat, fromLng]); if(!n) return;
        var url = gmapsDirections(fromLat,fromLng,n.lat,n.lng);
        window.location.href = url;
      }
      if(userLocation){ return go(userLocation[0], userLocation[1]); }
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){ go(pos.coords.latitude,pos.coords.longitude); },
          function(){ displayError('Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„ÙØªØ­ Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ².'); },
          {enableHighAccuracy:true,timeout:8000});
      }
    }

    document.getElementById('map-nearest').addEventListener('click', function(){
      function go(fromLat, fromLng){
        if (!FILTERED_CENTERS || !FILTERED_CENTERS.length){
          displayError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§ÙƒØ² Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠØ§. Ø£Ø¹Ø¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø£Ùˆ ÙˆØ³Ù‘Ø¹ Ø§Ù„Ø¨Ø­Ø«.');
          return;
        }
        var n = findNearest([fromLat, fromLng]);
        if(!n){ displayError('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ².'); return; }
        var url = gmapsDirections(fromLat, fromLng, n.lat, n.lng);
        window.location.href = url;
      }
      if (userLocation){
        go(userLocation[0], userLocation[1]);
      } else if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          function(pos){ go(pos.coords.latitude, pos.coords.longitude); },
          function(){ displayError('Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…ÙˆÙ‚Ø¹Ùƒ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ².'); },
          {enableHighAccuracy:true,timeout:8000}
        );
      } else {
        displayError('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.');
      }
    });

    /* ===== 6) ÙÙ„ØªØ±Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===== */
    function normalize(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
    function applyMapFilters(){
      const q = normalize(document.getElementById('map-search').value);
      const sector = document.getElementById('map-sector').value;
      FILTERED_CENTERS = BLOOD_CENTERS.filter(c=>{
        const hay = normalize((c.name||'')+' '+(c.address||''));
        const matchText = !q || hay.indexOf(q) !== -1;
        const s = (c.sector||'').toLowerCase();
        const matchSector = !sector || s === sector;
        return matchText && matchSector;
      });
      renderCenters(FILTERED_CENTERS);
      if (FILTERED_CENTERS.length){
        const avgLat = FILTERED_CENTERS.reduce((a,c)=>a+c.lat,0)/FILTERED_CENTERS.length;
        const avgLng = FILTERED_CENTERS.reduce((a,c)=>a+c.lng,0)/FILTERED_CENTERS.length;
        map.setView([avgLat,avgLng], 12);
      }
    }
    document.getElementById('map-apply').addEventListener('click', applyMapFilters);
    document.getElementById('map-reset').addEventListener('click', function(){
      document.getElementById('map-search').value='';
      document.getElementById('map-sector').value='';
      FILTERED_CENTERS = BLOOD_CENTERS.slice();
      renderCenters(FILTERED_CENTERS);
      map.setView([JEDDAH_LAT, JEDDAH_LNG], DEFAULT_ZOOM);
    });
    document.getElementById('map-search').addEventListener('keydown', function(e){
      if(e.key==='Enter'){ applyMapFilters(); }
    });
    document.getElementById('map-sector').addEventListener('change', applyMapFilters);

    /* ===== 7) Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ + Ø¨Ø¯Ø§Ø¦Ù„ ===== */
    function emailValid(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim()); }
    function addReminderFallbackUI(next_date){
      const cb = document.getElementById('chat-box');
      const wrap = document.createElement('div');
      wrap.className = 'message bot-message';
      const msg = encodeURIComponent(`ØªØ°ÙƒÙŠØ± Ø²Ù…Ø±Ø©: Ù…ÙˆØ¹Ø¯ ØªØ¨Ø±Ø¹Ùƒ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø¨ØªØ§Ø±ÙŠØ® ${next_date}.`);
      const wa = `https://wa.me/?text=${msg}`;
      const icsHref = `/api/reminder/ics/${next_date}`;
      wrap.innerHTML = `
        <div>ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯:</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
          <a class="go-map-btn" href="${icsHref}" download>ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªÙ‚ÙˆÙŠÙ… (.ics)</a>
          <a class="go-map-btn" href="${wa}" target="_blank" rel="noopener">Ø£Ø±Ø³Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
        </div>
      `;
      cb.appendChild(wrap);
      cb.scrollTop = cb.scrollHeight;
    }

    /* ===== 8) Ø§Ù„Ø´Ø§Øª ===== */
    var lastUserRaw = '';
    document.getElementById('user-input').addEventListener('keydown', function(e){
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('send-btn').click(); }
    });
    document.getElementById('send-btn').addEventListener('click', async function(){
      var inputField = document.getElementById('user-input');
      var rawMessage = (inputField.value||'').trim();
      if(!rawMessage) return;
      inputField.value = '';
      lastUserRaw = rawMessage;

      var loadingDiv = null, data = null;
      try{
        setInteractionState(false); loadingDiv = showLoading();
        var res = await fetch('/api/chat',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message:rawMessage})
        });
        if(!res.ok) throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: '+res.status+' '+res.statusText);
        data = await res.json();
      }catch(err){
        displayError('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: '+ err.message +'. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø®Ø§Ø¯Ù… Flask ÙŠØ¹Ù…Ù„.');
        removeLoading(loadingDiv); setInteractionState(true); return;
      }finally{
        removeLoading(loadingDiv); setInteractionState(true);
      }

      if(data){
        var finalUserMessage = data.corrected_message || rawMessage;
        displayMessage(finalUserMessage, 'user');
        displayAnswerWithControls(data.answer || '', finalUserMessage);
        if (isLocationIntent(rawMessage)) { openNearestAuto(); }
      }
    });

    /* ===== 9) Ø¨Ù†Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù‡Ù„ÙŠØ© ===== */
    function pill(id, group, value, label){
      return `<span class="pill" id="${id}" data-group="${group}" data-value="${value}">${label}</span>`;
    }
    function buildEligibilityUI(){
      const cb = document.getElementById('chat-box');
      const m = document.createElement('div');
      m.className = 'message bot-message';
      m.innerHTML = `
        <div style="font-weight:800;margin-bottom:8px;">Ù†Ù…ÙˆØ°Ø¬ ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</div>

        <div class="elig-row">
          <label>Ø§Ù„Ù†ÙˆØ¹:</label>
          ${pill('g-m','gender','male','Ø°ÙƒØ±')}
          ${pill('g-f','gender','female','Ø£Ù†Ø«Ù‰')}
        </div>

        <div class="elig-row">
          <label>Ø§Ù„Ø¹Ù…Ø± (Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª):</label>
          <input id="age" type="number" class="elig-input" min="1" max="100" placeholder="Ù…Ø«Ø§Ù„: 25"/>
        </div>

        <div class="elig-row">
          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…):</label>
          <input id="weight" type="number" class="elig-input" min="30" max="300" placeholder="Ù…Ø«Ø§Ù„: 60"/>
        </div>

        <div class="elig-row">
          <label>Ø¢Ø®Ø± ØªØ¨Ø±Ø¹ (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…):</label>
          <input id="last_donation_days" type="number" class="elig-input" min="0" max="2000" placeholder="Ù…Ø«Ø§Ù„: 100"/>
        </div>

        <div class="elig-row">
          <label>Ø£Ø¯ÙˆÙŠØ© Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ø¯Ù…ØŸ</label>
          ${pill('ac-y','on_ac','yes','Ù†Ø¹Ù…')}${pill('ac-n','on_ac','no','Ù„Ø§')}
        </div>

        <div class="elig-row">
          <label>Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ Ù„Ø¹Ø¯ÙˆÙ‰ Ù†Ø´Ø·Ø©ØŸ</label>
          ${pill('ab-y','on_ab','yes','Ù†Ø¹Ù…')}${pill('ab-n','on_ab','no','Ù„Ø§')}
        </div>

        <div class="elig-row">
          <label>Ø£Ø¹Ø±Ø§Ø¶ Ø²ÙƒØ§Ù…/Ø­Ù…Ù‰ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŸ</label>
          ${pill('cold-y','cold','yes','Ù†Ø¹Ù…')}${pill('cold-n','cold','no','Ù„Ø§')}
        </div>

        <div class="elig-row only-female" style="display:none;">
          <label>Ù‡Ù„ Ø£Ù†ØªÙ Ø­Ø§Ù…Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŸ</label>
          ${pill('preg-y','pregnant','yes','Ù†Ø¹Ù…')}${pill('preg-n','pregnant','no','Ù„Ø§')}
        </div>

        <div class="elig-row">
          <label>Ø¹Ù…Ù„ÙŠØ©/Ù‚Ù„Ø¹ Ø£Ø³Ù†Ø§Ù† Ø­Ø¯ÙŠØ«Ù‹Ø§ â€” ÙƒÙ… ÙŠÙˆÙ… Ù…Ø¶Ù‰ØŸ</label>
          <input id="recent_procedure_days" type="number" class="elig-input" min="0" max="400" placeholder="Ù…Ø«Ø§Ù„: 14"/>
        </div>

        <div class="elig-row">
          <label>ÙˆØ´Ù…/Ø«Ù‚Ø¨ Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± ÙƒÙ… Ø´Ù‡Ø±ØŸ</label>
          <input id="tattoo_months" type="number" class="elig-input" min="0" max="48" placeholder="Ù…Ø«Ø§Ù„: 12"/>
        </div>

        <div class="elig-row" style="margin-top:10px;">
          <button id="elig-submit" class="go-map-btn"><i class="fas fa-check"></i> Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</button>
        </div>

        <div id="elig-result" class="elig-result"><span class="muted">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· "Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø£Ù‡Ù„ÙŠØ©".</span></div>
      `;
      cb.appendChild(m);
      cb.scrollTop = cb.scrollHeight;
    }

    // ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¨ÙˆØ¨ (gender/yes-no) Ø¨ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø«
    document.addEventListener('click', function(e){
      if (e.target && e.target.classList.contains('pill')) {
        const g = e.target.dataset.group;
        document.querySelectorAll('.pill[data-group="'+g+'"]').forEach(p=>p.classList.remove('active'));
        e.target.classList.add('active');

        // Ø¥Ø¸Ù‡Ø§Ø± Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ù…Ù„ ÙÙ‚Ø· Ù„Ùˆ Ø£Ù†Ø«Ù‰
        if (g === 'gender') {
          const v = e.target.dataset.value;
          const fem = document.querySelector('.only-female');
          if (fem) fem.style.display = (v === 'female') ? 'block' : 'none';
        }
      }
    });

    // Ø²Ø± ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©
    document.getElementById('eligibility-flow-btn').addEventListener('click', function(){
      buildEligibilityUI();
    });

    // Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ù‡Ù„ÙŠØ© (ØªÙÙˆÙŠØ¶ Ø£Ø­Ø¯Ø§Ø« ÙŠØ¶Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ø²Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§)
    document.addEventListener('click', async function(e){
      if (e.target && e.target.id === 'elig-submit') {
        const gActive = document.querySelector('.pill[data-group="gender"].active');
        const g = gActive ? gActive.dataset.value : null;

        const age    = parseInt(document.getElementById('age')?.value || '0', 10);
        const weight = parseInt(document.getElementById('weight')?.value || '0', 10);
        const last   = parseInt(document.getElementById('last_donation_days')?.value || '9999', 10);
        const recent = parseInt(document.getElementById('recent_procedure_days')?.value || '9999', 10);
        const tattoo = parseInt(document.getElementById('tattoo_months')?.value || '999', 10);

        const getYN = (grp)=> {
          const a = document.querySelector('.pill[data-group="'+grp+'"].active');
          return a ? (a.dataset.value === 'yes') : false;
        };
        const on_ac = getYN('on_ac');
        const on_ab = getYN('on_ab');
        const cold  = getYN('cold');
        let pregnant = false;
        if (g === 'female') pregnant = getYN('pregnant');

        const payload = {
          age, weight, last_donation_days:last,
          on_anticoagulants:on_ac,
          on_antibiotics:on_ab,
          has_cold:cold,
          pregnant,
          recent_procedure_days:recent,
          tattoo_months:tattoo
        };

        try{
          const r = await fetch('/api/eligibility/evaluate',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!r.ok) throw new Error('HTTP '+r.status);
          const j = await r.json();
          const box = document.getElementById('elig-result');
          if (!box) return;

          const ok = !!j.eligible;
          const reasons = j.reasons || [];
          const nextd = j.next_eligible_date || '-';

          box.className = 'elig-result ' + (ok ? 'ok' : 'bad');
          box.innerHTML = `
            <div><strong>${ok?'âœ… Ù…Ø¤Ù‡Ù„ Ù„Ù„ØªØ¨Ø±Ø¹ Ø­Ø§Ù„ÙŠØ§Ù‹':'â›” ØºÙŠØ± Ù…Ø¤Ù‡Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹'}</strong></div>
            <div>ğŸ—“ï¸ Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…Ù†Ø§Ø³Ø¨: <strong>${nextd}</strong></div>
            ${reasons.length?('<ul style="margin:8px 16px 0 0">'+reasons.map(r=>'<li>'+r+'</li>').join('')+'</ul>'):'<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù†Ø¹ ÙˆØ§Ø¶Ø­Ø©.</div>'}
          `;
        }catch(err){
          displayError('ØªØ¹Ø°Ù‘Ø± ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ù‡Ù„ÙŠØ©: '+err.message);
        }
      }
    });

    /* ===== 10) Ø²Ø± Ø§Ù„ØªØ°ÙƒÙŠØ± ===== */
    document.getElementById('reminder-btn').addEventListener('click', async function(){
      const who = (prompt('Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') || 'User').trim();
      const email = (prompt('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ°ÙƒÙŠØ± (Ù…Ø«Ø§Ù„: name@example.com):') || '').trim();

      if (!emailValid(email)){
        displayError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­.');
        return;
      }

      try{
        const r = await fetch('/api/reminder',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({user_hint:who, email})
        });
        const j = await r.json();
        if(!j.ok){
          displayError('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ±.');
          return;
        }

        if (j.email_status && j.email_status.sent){
          displayMessage('ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. Ù…ÙˆØ¹Ø¯Ùƒ Ø§Ù„Ù…Ù‚ØªØ±Ø­: '+ j.next_date,'bot');
        } else {
          displayError('ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ('+(j.email_status && j.email_status.message ? j.email_status.message : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')+').');
          displayMessage('ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ø·Ø±Ù‚ Ø¨Ø¯ÙŠÙ„Ø© Ø£Ø¯Ù†Ø§Ù‡:','bot');
        }

        addReminderFallbackUI(j.next_date);
      }catch(e){
        displayError('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ°ÙƒÙŠØ±.');
      }
    });

    /* ===== 11) FAQ Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹ ===== */
    window.sendQuickQuestion = function(q){
      var f = document.getElementById('user-input');
      f.value = q;
      document.getElementById('send-btn').click();
    };
  </script>
</body>
</html>
