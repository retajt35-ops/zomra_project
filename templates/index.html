<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø²Ù…Ø±Ø© | Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø¯Ù…</title>

  <!-- Ø®Ø·ÙˆØ· ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --primary-red:#B30000;--burgundy-dark:#800020;--primary-text:#333;--secondary-text:#666;
      --background-light:#F8F8F8;--card-background:#FFF;
      --gradient-hospital-btn:linear-gradient(to left,#A52A2A,#C04000);
      --gradient-urgent-btn:linear-gradient(to left,#800020,#B30000);
      --gradient-map-btn:linear-gradient(to left,#A52A2A,#C04000);
      --gradient-whatsapp-btn:linear-gradient(to left,#25D366,#3EDF7D);
      --gradient-header:linear-gradient(to right,#fff,#F4F4F4);
      --gradient-send:linear-gradient(to right,var(--burgundy-dark),var(--primary-red));
      --bot-bubble:#EBF2F7;--user-bubble:var(--primary-red);
      --shadow-subtle:0 4px 12px rgba(0,0,0,.08);
      --border-radius-lg:12px;--border-radius-sm:6px;
      --critical-red:#DC3545;--high-yellow:#FFC107;--low-blue:#17A2B8;
    }
    body{
      font-family:'Tajawal',sans-serif;
      background:var(--background-light);
      margin:0;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
      padding:20px;
      box-sizing:border-box;
      color:var(--primary-text)
    }
    .main-wrapper{
      display:flex;
      flex-direction:row-reverse;
      width:100%;
      max-width:1300px;
      gap:25px;
      height:100%
    }
    .chat-container{
      flex:3;
      background:var(--card-background);
      border-radius:var(--border-radius-lg);
      box-shadow:var(--shadow-subtle);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      height:calc(100vh - 40px);
      min-height:700px
    }
    .sidebar-container{
      flex:1.2;
      display:flex;
      flex-direction:column;
      gap:20px
    }
    .sidebar-box{
      background:var(--card-background);
      border-radius:var(--border-radius-lg);
      box-shadow:var(--shadow-subtle);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:15px
    }
    .sidebar-box h2{
      color:var(--burgundy-dark);
      font-size:1.3em;
      font-weight:800;
      margin:0;
      padding-bottom:10px;
      border-bottom:2px solid #EEE
    }
    .sidebar-btn{
      display:flex;
      flex-direction:row-reverse;
      align-items:center;
      gap:15px;
      padding:15px;
      border-radius:var(--border-radius-sm);
      text-decoration:none;
      color:#fff;
      transition:all .2s;
      border:none;
      cursor:pointer;
      min-height:60px;
      box-shadow:0 4px 8px rgba(0,0,0,.15)
    }
    .sidebar-btn.hospital{background-image:var(--gradient-hospital-btn)}
    .sidebar-btn.urgent{background-image:var(--gradient-urgent-btn)}
    .sidebar-btn.map{background-image:var(--gradient-map-btn)}
    .sidebar-btn.whatsapp{background-image:var(--gradient-whatsapp-btn)}
    .sidebar-btn .icon{font-size:1.8em;color:#fff;font-weight:900}
    .sidebar-btn .label{font-weight:700;font-size:1em;flex-grow:1;text-align:right}
    .sidebar-btn:hover:not(:disabled){
      transform:scale(1.02);
      opacity:.9;
      box-shadow:0 8px 16px rgba(0,0,0,.25)
    }
    .sidebar-btn:disabled{cursor:not-allowed;opacity:.6}

    header{
      background:var(--gradient-header);
      padding:20px;
      border-bottom:1px solid #E0E0E0;
      text-align:right
    }
    .header-top{
      display:flex;
      flex-direction:row-reverse;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    header h1{
      font-size:1.6em;
      margin:0;
      color:var(--burgundy-dark);
      font-weight:800;
      display:flex;
      align-items:center;
      flex-direction:row-reverse;
      gap:10px
    }
    .lang-toggle-btn{
      border:none;
      padding:8px 14px;
      border-radius:999px;
      background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
      cursor:pointer;
      font-weight:700;
      font-size:.9em;
      min-width:80px;
    }
    .lang-toggle-btn:hover{
      background:#f3f3f3;
    }

    #chat-box{
      flex-grow:1;
      padding:20px 25px;
      overflow-y:auto;
      background:#FAFAFA;
      display:flex;
      flex-direction:column
    }

    .message{
      padding:14px 20px;
      margin-bottom:15px;
      border-radius:var(--border-radius-lg);
      max-width:70%;
      line-height:1.7;
      font-size:.95em;
      box-shadow:0 1px 2px rgba(0,0,0,.05)
    }
    .bot-message{
      background:var(--bot-bubble);
      align-self:flex-start;
      border-bottom-left-radius:var(--border-radius-sm)
    }
    .user-message{
      background:var(--user-bubble);
      color:#fff;
      align-self:flex-end;
      border-bottom-right-radius:var(--border-radius-sm)
    }
    .loading-message{font-weight:700;color:var(--secondary-text);background:#F0F0F0}
    .error-message{color:#666;font-weight:700}

    .input-area{
      display:flex;
      align-items:center;
      padding:15px 20px;
      border-top:1px solid #E0E0E0;
      background:var(--card-background);
      flex-shrink:0;
      gap:8px
    }
    #user-input{
      flex-grow:1;
      padding:12px 18px;
      border:2px solid var(--primary-red);
      border-radius:var(--border-radius-lg);
      font-size:1em;
      outline:none;
      transition:border-color .2s
    }
    #user-input:focus{border-color:var(--burgundy-dark)}
    #send-btn{
      background:var(--gradient-send);
      color:#fff;
      border:none;
      padding:12px 24px;
      border-radius:var(--border-radius-lg);
      cursor:pointer;
      font-size:1em;
      font-weight:700;
      transition:opacity .2s,background .2s;
      white-space:nowrap
    }
    #send-btn:hover:not(:disabled){opacity:.9}
    #send-btn:disabled{opacity:.6;cursor:not-allowed}

    #mic-btn{
      background:#eee;
      border:none;
      border-radius:50%;
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:1.1em;
      transition:background .2s,transform .2s
    }
    #mic-btn:hover{background:#ddd;transform:translateY(-1px)}

    #mic-btn.recording{
      background:#ffcccc;
      animation:pulse 1s infinite;
    }
    @keyframes pulse{
      0%{transform:scale(1);}
      50%{transform:scale(1.08);}
      100%{transform:scale(1);}
    }

    .translation-block{margin-top:10px}
    .toggle-btn{
      margin-top:8px;
      background:#eee;
      border:none;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:700
    }
    .helper-btn{
      margin-top:8px;
      background:#fff;
      border:1px solid #ddd;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:700
    }
    .inline-note{font-size:.9em;color:var(--secondary-text);margin-top:6px}

    .faq-list{display:flex;flex-direction:column;gap:10px}
    .faq-item{
      background:#fafafa;
      border:1px solid #eee;
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      transition:transform .15s, background .15s, border-color .15s;
      user-select:none
    }
    .faq-item:hover{
      transform:translateY(-1px);
      background:#fefefe;
      border-color:#e2e2e2
    }

    .pill{
      display:inline-block;
      padding:6px 10px;
      border:1px solid #ddd;
      border-radius:999px;
      margin:4px;
      cursor:pointer;
      font-weight:700;
      background:#fff
    }
    .pill.active{background:#B30000;color:#fff;border-color:#B30000}
    .elig-row{margin:8px 0}
    .elig-row label{
      display:block;
      margin-bottom:6px;
      font-weight:800;
      color:#555
    }
    .elig-input{
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:8px;
      width:100%;
      max-width:260px;
      font-family:inherit
    }
    .elig-result{
      margin-top:10px;
      padding:10px;
      border-radius:10px;
      border:1px dashed #ddd;
      background:#fafafa
    }
    .elig-result.ok{border-color:#3fb950;background:#f1fff3}
    .elig-result.bad{border-color:#d73a49;background:#fff5f5}
    .muted{color:#888}

    .go-map-btn{
      display:inline-block;
      margin-top:8px;
      padding:8px 12px;
      border-radius:10px;
      background:linear-gradient(to left,#800020,#B30000);
      color:#fff;
      text-decoration:none;
      font-weight:800;
      border:none;
      box-shadow:0 4px 8px rgba(0,0,0,.15);
      cursor:pointer
    }
    .go-map-btn:hover{opacity:.92;transform:translateY(-1px)}
    .hospital-popup strong{display:block;margin-bottom:6px}
    .details-label{font-weight:700}

    .map-filters{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      padding:10px;
      border-top:1px solid #eee;
      background:#fff
    }
    .map-filters input,.map-filters select{
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:8px;
      font-family:inherit
    }
    .map-filters .counter{font-size:.9em;color:#555;margin-inline-start:auto}

    .urgent-wrapper{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:10px
    }
    .urgent-card{
      border-radius:10px;
      padding:12px 14px;
      background:#fff4f4;
      border:1px solid #f1c0c0;
      cursor:pointer;
      transition:transform .15s, box-shadow .15s
    }
    .urgent-card:hover{
      transform:translateY(-1px);
      box-shadow:var(--shadow-subtle)
    }
    .urgent-card .title{font-weight:800;margin-bottom:4px}
    .urgent-card .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:.8em;
      margin-bottom:6px;
      color:#fff
    }
    .urgent-card.critical{border-color:#DC3545;background:#ffe6e9}
    .urgent-card.critical .badge{background:#DC3545}
    .urgent-card.high{border-color:#FFC107;background:#fff8e1}
    .urgent-card.high .badge{background:#FFC107;color:#000}
    .urgent-card.normal{border-color:#17A2B8;background:#e5f8ff}
    .urgent-card.normal .badge{background:#17A2B8}

    @media (max-width: 900px){
      .main-wrapper{
        flex-direction:column;
        height:auto
      }
      .chat-container{
        height:auto;
        min-height:500px
      }
    }
  </style>
</head>
<body>

  <div class="main-wrapper">
    <div class="chat-container">
      <header>
        <div class="header-top">
          <h1 id="header-title">Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø²Ù…Ø±Ø© <span class="blood-drop">ğŸ©¸</span></h1>
          <button id="lang-toggle" class="lang-toggle-btn">English</button>
        </div>
      </header>

      <div id="chat-box">
        <div class="message bot-message" id="welcome-message">
          <div class="welcome-main">
            Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong style="color:var(--primary-red);font-weight:800;">Ø²Ù…Ø±Ø©</strong> â€” Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ø¤Ø§Ù„ Ø¹Ù† <strong>Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</strong>.
          </div>
          <div class="translation-block">
            <button class="toggle-btn" onclick="toggleNext(this)">Show English translation</button>
            <div class="ar-translation" style="display:none;margin-top:6px;direction:ltr;text-align:left;">
              Welcome to <strong style="color:#B30000;font-weight:800;">Zomrah</strong> â€” start by asking about <strong>donation eligibility</strong>.
            </div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <button id="mic-btn" type="button" title="Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØªÙŠ">
          <i class="fas fa-microphone"></i>
        </button>
        <input type="file" id="audio-input" accept="audio/*" style="display:none" />
        <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." autofocus/>
        <button id="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>

    <div class="sidebar-container">
      <div class="sidebar-box map-widget" style="padding:0;overflow:hidden;border-radius:12px;">
        <div id="mapid" style="height:220px;"></div>
        <button class="sidebar-btn hospital" id="locate-center-btn" style="border-radius:0;margin:0;width:100%;">
          <i class="fas fa-map-pin icon" style="font-size:1.4em;"></i>
          <span class="label" id="locate-center-label">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ ÙˆØ£Ø¸Ù‡Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ²</span>
        </button>

        <div class="map-filters">
          <input id="map-search" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ø§Ù„Ø­ÙŠ..." />
          <select id="map-sector">
            <option value="">Ø§Ù„Ù‚Ø·Ø§Ø¹: Ø§Ù„ÙƒÙ„</option>
            <option value="public">Ø­ÙƒÙˆÙ…ÙŠ ÙÙ‚Ø·</option>
            <option value="private">Ø®Ø§Øµ ÙÙ‚Ø·</option>
          </select>
          <button id="map-apply" class="helper-btn">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="map-reset" class="helper-btn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
          <button id="map-nearest" class="go-map-btn">Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„Ø¢Ù†</button>
          <div class="counter" id="map-counter">â€”</div>
        </div>
      </div>

      <button class="sidebar-btn urgent" id="urgent-needs-btn">
        <i class="fas fa-exclamation-triangle icon"></i>
        <span class="label" id="urgent-label">Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ Ù„Ù„Ø¯Ù…</span>
      </button>

      <button class="sidebar-btn map" id="eligibility-flow-btn">
        <i class="fas fa-clipboard-check icon"></i>
        <span class="label" id="eligibility-label">ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</span>
      </button>

      <button class="sidebar-btn map" id="reminder-btn">
        <i class="fas fa-bell icon"></i>
        <span class="label" id="reminder-label">ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ¨Ø±Ø¹</span>
      </button>

      <!-- Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ + Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ -->
      <a class="sidebar-btn whatsapp" target="_blank" rel="noopener"
         href="https://wa.me/966504635135?text=Ø£Ù‡Ù„Ø§Ù‹ØŒ%20Ø£ÙˆØ¯%20Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±%20Ø¹Ù†%20Ø®Ø¯Ù…Ø©%20Ø²Ù…Ø±Ø©.%0AHello,%20I'd%20like%20to%20ask%20about%20the%20Zomrah%20service.">
        <i class="fab fa-whatsapp icon"></i>
        <span class="label" id="whatsapp-label">ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± (ÙˆØ§ØªØ³Ø§Ø¨)</span>
      </a>

      <div class="sidebar-box">
        <h2 id="faq-title">â“ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø´Ø§Ø¦Ø¹Ø©</h2>
        <div class="faq-list">
          <div class="faq-item" id="faq-1" onclick="sendQuickQuestion('Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ')">Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
          <div class="faq-item" id="faq-2" onclick="sendQuickQuestion('Ù…ØªÙ‰ Ø£Ù‚Ø¯Ø± Ø£ØªØ¨Ø±Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ')">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø¨ÙŠÙ† Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª</div>
          <div class="faq-item" id="faq-3" onclick="sendQuickQuestion('Ù‡Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù… Ù…Ø¤Ù„Ù…ØŸ')">Ø§Ù„Ø¢Ø«Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ù…Ø®Ø§ÙˆÙ</div>
          <!-- Ø£Ø³Ø¦Ù„Ø© Ø¥Ø¶Ø§ÙÙŠØ© ÙƒÙ…Ø§ Ø·Ù„Ø¨ØªÙ -->
          <div class="faq-item" id="faq-4" onclick="sendQuickQuestion('Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ')">Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø±Ø¹</div>
          <div class="faq-item" id="faq-5" onclick="sendQuickQuestion('Ù‡Ù„ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¥Ø°Ø§ Ø¹Ù†Ø¯ÙŠ Ù…Ø±Ø¶ Ù…Ø²Ù…Ù†ØŸ')">Ø§Ù„ØªØ¨Ø±Ø¹ Ù…Ø¹ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =======================
    // Ù„ØºØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø¹Ø±Ø¨ÙŠ / English)
    // =======================
    let CURRENT_LANG = 'ar';

    function applyLanguage(){
      document.documentElement.lang = CURRENT_LANG;
      document.documentElement.dir = (CURRENT_LANG === 'ar') ? 'rtl' : 'ltr';

      const headerTitle = document.getElementById('header-title');
      if(headerTitle){
        headerTitle.innerHTML =
          CURRENT_LANG === 'ar'
            ? 'Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø²Ù…Ø±Ø© <span class="blood-drop">ğŸ©¸</span>'
            : 'Chat with Zomrah <span class="blood-drop">ğŸ©¸</span>';
      }

      const langBtn = document.getElementById('lang-toggle');
      if(langBtn){
        langBtn.textContent = CURRENT_LANG === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
        langBtn.title = CURRENT_LANG === 'ar'
          ? 'Switch interface to English'
          : 'ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
      }

      const input = document.getElementById('user-input');
      if(input){
        input.placeholder = CURRENT_LANG === 'ar'
          ? 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...'
          : 'Type your question here...';
      }

      const sendBtn = document.getElementById('send-btn');
      if(sendBtn){
        sendBtn.textContent = CURRENT_LANG === 'ar' ? 'Ø¥Ø±Ø³Ø§Ù„' : 'Send';
      }

      const locateLbl = document.getElementById('locate-center-label');
      if(locateLbl){
        locateLbl.textContent = CURRENT_LANG === 'ar'
          ? 'Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ ÙˆØ£Ø¸Ù‡Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ²'
          : 'Locate me and show centers';
      }

      const urgentLbl = document.getElementById('urgent-label');
      if(urgentLbl){
        urgentLbl.textContent = CURRENT_LANG === 'ar'
          ? 'Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ Ù„Ù„Ø¯Ù…'
          : 'Urgent blood needs';
      }

      const eligLbl = document.getElementById('eligibility-label');
      if(eligLbl){
        eligLbl.textContent = CURRENT_LANG === 'ar'
          ? 'ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©'
          : 'Check eligibility';
      }

      const remLbl = document.getElementById('reminder-label');
      if(remLbl){
        remLbl.textContent = CURRENT_LANG === 'ar'
          ? 'ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ¨Ø±Ø¹'
          : 'Donation reminder';
      }

      const waLbl = document.getElementById('whatsapp-label');
      if(waLbl){
        waLbl.textContent = CURRENT_LANG === 'ar'
          ? 'ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± (ÙˆØ§ØªØ³Ø§Ø¨)'
          : 'Contact us (WhatsApp)';
      }

      const faqTitle = document.getElementById('faq-title');
      if(faqTitle){
        faqTitle.textContent = CURRENT_LANG === 'ar'
          ? 'â“ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø´Ø§Ø¦Ø¹Ø©'
          : 'â“ Common questions';
      }

      const faq1 = document.getElementById('faq-1');
      const faq2 = document.getElementById('faq-2');
      const faq3 = document.getElementById('faq-3');
      const faq4 = document.getElementById('faq-4');
      const faq5 = document.getElementById('faq-5');

      if(faq1){
        faq1.textContent = CURRENT_LANG === 'ar'
          ? 'Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'
          : 'Basic donation requirements';
        faq1.setAttribute('onclick',
          CURRENT_LANG === 'ar'
            ? "sendQuickQuestion('Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ')"
            : "sendQuickQuestion('What are the conditions for blood donation?')"
        );
      }
      if(faq2){
        faq2.textContent = CURRENT_LANG === 'ar'
          ? 'Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø¨ÙŠÙ† Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª'
          : 'Time between donations';
        faq2.setAttribute('onclick',
          CURRENT_LANG === 'ar'
            ? "sendQuickQuestion('Ù…ØªÙ‰ Ø£Ù‚Ø¯Ø± Ø£ØªØ¨Ø±Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ')"
            : "sendQuickQuestion('When can I donate again?')"
        );
      }
      if(faq3){
        faq3.textContent = CURRENT_LANG === 'ar'
          ? 'Ø§Ù„Ø¢Ø«Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ù…Ø®Ø§ÙˆÙ'
          : 'Side effects & concerns';
        faq3.setAttribute('onclick',
          CURRENT_LANG === 'ar'
            ? "sendQuickQuestion('Ù‡Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù… Ù…Ø¤Ù„Ù…ØŸ')"
            : "sendQuickQuestion('Is blood donation painful?')"
        );
      }
      if(faq4){
        faq4.textContent = CURRENT_LANG === 'ar'
          ? 'Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø±Ø¹'
          : 'How to prepare before donation';
        faq4.setAttribute('onclick',
          CURRENT_LANG === 'ar'
            ? "sendQuickQuestion('Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ')"
            : "sendQuickQuestion('What should I do before donating blood?')"
        );
      }
      if(faq5){
        faq5.textContent = CURRENT_LANG === 'ar'
          ? 'Ø§Ù„ØªØ¨Ø±Ø¹ Ù…Ø¹ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©'
          : 'Donation with chronic diseases';
        faq5.setAttribute('onclick',
          CURRENT_LANG === 'ar'
            ? "sendQuickQuestion('Ù‡Ù„ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¥Ø°Ø§ Ø¹Ù†Ø¯ÙŠ Ù…Ø±Ø¶ Ù…Ø²Ù…Ù†ØŸ')"
            : "sendQuickQuestion('Can I donate if I have a chronic disease?')"
        );
      }

      const mapSearch = document.getElementById('map-search');
      if(mapSearch){
        mapSearch.placeholder = CURRENT_LANG === 'ar'
          ? 'Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ø§Ù„Ø­ÙŠ...'
          : 'Search by hospital or district...';
      }

      const sectorSelect = document.getElementById('map-sector');
      if(sectorSelect && sectorSelect.options.length >= 3){
        if(CURRENT_LANG === 'ar'){
          sectorSelect.options[0].text = 'Ø§Ù„Ù‚Ø·Ø§Ø¹: Ø§Ù„ÙƒÙ„';
          sectorSelect.options[1].text = 'Ø­ÙƒÙˆÙ…ÙŠ ÙÙ‚Ø·';
          sectorSelect.options[2].text = 'Ø®Ø§Øµ ÙÙ‚Ø·';
        }else{
          sectorSelect.options[0].text = 'Sector: All';
          sectorSelect.options[1].text = 'Public only';
          sectorSelect.options[2].text = 'Private only';
        }
      }

      const mapApply = document.getElementById('map-apply');
      if(mapApply){
        mapApply.textContent = CURRENT_LANG === 'ar' ? 'ØªØ·Ø¨ÙŠÙ‚' : 'Apply';
      }
      const mapReset = document.getElementById('map-reset');
      if(mapReset){
        mapReset.textContent = CURRENT_LANG === 'ar' ? 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†' : 'Reset';
      }
      const mapNearest = document.getElementById('map-nearest');
      if(mapNearest){
        mapNearest.textContent = CURRENT_LANG === 'ar' ? 'Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„Ø¢Ù†' : 'Nearest center now';
      }

      // Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù†ÙØ³Ù‡Ø§ (Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø©)
      const welcome = document.getElementById('welcome-message');
      if(welcome){
        const mainDiv = welcome.querySelector('.welcome-main');
        const transBtn = welcome.querySelector('.translation-block .toggle-btn');
        const transDiv = welcome.querySelector('.translation-block .ar-translation');

        if(mainDiv){
          mainDiv.innerHTML = (CURRENT_LANG === 'ar')
            ? 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong style="color:var(--primary-red);font-weight:800;">Ø²Ù…Ø±Ø©</strong> â€” Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ø¤Ø§Ù„ Ø¹Ù† <strong>Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</strong>.'
            : 'Welcome to <strong style="color:#B30000;font-weight:800;">Zomrah</strong> â€” start by asking about <strong>donation eligibility</strong>.';
        }
        if(transBtn && transDiv){
          if(CURRENT_LANG === 'ar'){
            transBtn.textContent = 'Show English translation';
            transDiv.style.direction = 'ltr';
            transDiv.style.textAlign = 'left';
            transDiv.innerHTML =
              'Welcome to <strong style="color:#B30000;font-weight:800;">Zomrah</strong> â€” start by asking about <strong>donation eligibility</strong>.';
          }else{
            transBtn.textContent = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
            transDiv.style.direction = 'rtl';
            transDiv.style.textAlign = 'right';
            transDiv.innerHTML =
              'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong style="color:var(--primary-red);font-weight:800;">Ø²Ù…Ø±Ø©</strong> â€” Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ø¤Ø§Ù„ Ø¹Ù† <strong>Ø´Ø±ÙˆØ· Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</strong>.';
          }
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      const langBtn = document.getElementById('lang-toggle');
      if(langBtn){
        langBtn.addEventListener('click', function(){
          CURRENT_LANG = (CURRENT_LANG === 'ar') ? 'en' : 'ar';
          applyLanguage();
        });
      }
      applyLanguage();
    });

    // =======================
    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø¹ ØªÙ…Ø±ÙŠØ± CURRENT_LANG Ù„Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯)
    // =======================

    let SMTP_READY = false;
    let SENDGRID_READY = false;
    fetch('/health')
      .then(r=>r.json())
      .then(j=>{
        SMTP_READY = !!j.smtp_ready;
        SENDGRID_READY = !!j.sendgrid_ready;
      })
      .catch(()=>{ SMTP_READY = false; SENDGRID_READY = false; });

    function toggleNext(btn){
      var el = btn.nextElementSibling;
      if(!el) return;
      var shown = el.style.display !== 'none';
      el.style.display = shown ? 'none' : 'block';
      if(CURRENT_LANG === 'ar'){
        btn.textContent = shown ? 'Show English translation' : 'Hide English translation';
      }else{
        btn.textContent = shown ? 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
      }
    }

    function showLoading(){
      var chatBox = document.getElementById('chat-box');
      var loadingDiv = document.createElement('div');
      loadingDiv.className = 'message bot-message loading-message';
      loadingDiv.id = 'loading-indicator';
      loadingDiv.textContent = (CURRENT_LANG === 'ar')
        ? 'Ø²Ù…Ø±Ø© ØªÙƒØªØ¨... ğŸ§ '
        : 'Zomrah is typing... ğŸ§ ';
      chatBox.appendChild(loadingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      return loadingDiv;
    }
    function removeLoading(loadingDiv){ if(loadingDiv && loadingDiv.parentNode){ loadingDiv.parentNode.removeChild(loadingDiv); } }
    function displayMessage(text, sender){
      var chatBox = document.getElementById('chat-box');
      var msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
      msgDiv.textContent = text;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    function displayError(text){
      var chatBox = document.getElementById('chat-box');
      var msgDiv = document.createElement('div');
      msgDiv.className = 'message bot-message';
      msgDiv.innerHTML = '<span class="error-message">'+ text +'</span>';
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function displayAnswerWithControls(summarizedText, originalQuestion){
      var cb = document.getElementById('chat-box');
      var m = document.createElement('div');
      m.className = 'message bot-message';

      var main = document.createElement('div');
      main.className = 'ar-text';
      main.innerHTML = (summarizedText || '').replace(/\n/g,'<br>');
      m.appendChild(main);

      var btn = document.createElement('button');
      btn.className = 'helper-btn';
      btn.textContent = (CURRENT_LANG === 'ar' ? 'ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±' : 'More details');
      btn.dataset.state = 'collapsed';
      btn.dataset.summarized = summarizedText || '';
      btn.dataset.question = originalQuestion || '';
      m.appendChild(btn);

      var tr = document.createElement('div');
      tr.className = 'translation-block';
      var toggleLabel = (CURRENT_LANG === 'ar')
        ? 'Show English translation'
        : 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
      tr.innerHTML =
        '<button class="toggle-btn" onclick="toggleNext(this)">'+toggleLabel+'</button>'+
        '<div class="ar-translation" style="display:none;margin-top:6px;direction:ltr;text-align:left;">(Translation appears here if implemented)</div>';
      m.appendChild(tr);

      btn.addEventListener('click', async function(){
        if (this.dataset.state === 'collapsed') {
          if (!this.dataset.detailed) {
            try{
              const res = await fetch('/api/chat', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ message: this.dataset.question || '', detail: true, lang: CURRENT_LANG })
              });
              if(!res.ok) throw new Error('HTTP '+res.status);
              const j = await res.json();
              this.dataset.detailed = j.answer || this.dataset.summarized;
            }catch(e){
              displayError(CURRENT_LANG === 'ar'
                ? 'âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„.'
                : 'âŒ Failed to fetch details.');
              return;
            }
          }
          main.innerHTML = (this.dataset.detailed || '').replace(/\n/g,'<br>');
          this.textContent = (CURRENT_LANG === 'ar' ? 'Ø¥Ø¸Ù‡Ø§Ø± Ø£Ù‚Ù„' : 'Show less');
          this.dataset.state = 'expanded';
        } else {
          main.innerHTML = (this.dataset.summarized || '').replace(/\n/g,'<br>');
          this.textContent = (CURRENT_LANG === 'ar' ? 'ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±' : 'More details');
          this.dataset.state = 'collapsed';
        }
      });

      cb.appendChild(m);
      cb.scrollTop = cb.scrollHeight;
    }

    function setInteractionState(enabled){
      ['send-btn','user-input','urgent-needs-btn','locate-center-btn','eligibility-flow-btn','reminder-btn','mic-btn'].forEach(function(id){
        var el = document.getElementById(id);
        if(el){ el.disabled = !enabled; }
      });
      var faq = document.querySelectorAll('.faq-item');
      for(var i=0;i<faq.length;i++){
        faq[i].style.pointerEvents = enabled ? 'auto' : 'none';
        faq[i].style.opacity = enabled ? '1' : '0.6';
        faq[i].style.cursor = enabled ? 'pointer' : 'default';
      }
    }

    const LOCATION_RE = /(Ù…ÙˆÙ‚Ø¹|Ø§Ù„Ù…ÙˆÙ‚Ø¹|Ø£Ù‚Ø±Ø¨|Ù‚Ø±ÙŠØ¨|Ø§Ù„Ø®Ø±Ø§Ø¦Ø·|Ø§Ù„Ø®Ø±ÙŠØ·Ø©|map|nearest|location|directions|ÙˆÙŠÙ†|Ø§Ù‚Ø±Ø¨)/i;
    function isLocationIntent(t){ return LOCATION_RE.test((t||'').trim()); }

    var JEDDAH_LAT = 21.5433, JEDDAH_LNG = 39.1728, DEFAULT_ZOOM = 11;
    var BLOOD_CENTERS = [];
    var FILTERED_CENTERS = [];
    var markersLayer = null;

    function toRad(v){ return v*Math.PI/180; }
    function haversine(lat1,lng1,lat2,lng2){
      const R=6371;
      const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    function gmapsDirections(fromLat,fromLng,toLat,toLng){
      return 'https://www.google.com/maps/dir/?api=1&origin='+fromLat+','+fromLng+'&destination='+toLat+','+toLng+'&travelmode=driving';
    }
    function gmapsLinkByName(name){ return 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(name); }

    function findNearest(from){
      var best=null, bestD=1e9;
      for(var i=0;i<FILTERED_CENTERS.length;i++){
        var c=FILTERED_CENTERS[i];
        var d=haversine(from[0],from[1],c.lat,c.lng);
        if(d<bestD){ bestD=d; best=c; }
      }
      return best;
    }

    function detectSector(name=''){
      const t = (name||'').trim();
      const pub = /(Ø§Ù„Ù…Ù„Ùƒ|Ø§Ù„ØªØ®ØµØµÙŠ|Ø§Ù„Ø¹Ø§Ù…|Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©|Ø§Ù„Ù‚ÙˆØ§Øª|Ø§Ù„Ø­Ø±Ø³|Ù…Ø¬Ù…Ø¹|Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ùƒ|Ø§Ù„Ø«ØºØ±|Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ©)/;
      const pri = /(Ø§Ù„Ø¯ÙƒØªÙˆØ±|ÙÙ‚ÙŠÙ‡|Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ|Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù…ØªØ­Ø¯ÙˆÙ†|Ø§Ù„Ø³Ù„Ø§Ù…Ø©|Ø§Ù„Ù…ØºØ±Ø¨ÙŠ|Ø§Ù„Ø­ÙŠØ§Ø©|Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø¯ÙˆÙ„ÙŠ|Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø¯ÙˆÙ„ÙŠ|Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ø§Ù„Ù…Ø§Ù†ÙŠ)/;
      if (pub.test(t)) return 'public';
      if (pri.test(t)) return 'private';
      return '';
    }

    function createPopupContent(c){
      var link = gmapsLinkByName(c.name);
      var phoneHtml = c.phone ? ('<p><span class="details-label">ğŸ“ Ø§Ù„ØªÙˆØ§ØµÙ„:</span> <a href="tel:'+c.phone+'" style="color:#0b7dda">'+c.phone+'</a></p>') : '<p><span class="details-label">ğŸ“ Ø§Ù„ØªÙˆØ§ØµÙ„:</span> â€”</p>';
      var hoursLabel = (CURRENT_LANG === 'ar') ? 'â±ï¸ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„:' : 'â±ï¸ Working hours:';
      var addrLabel  = (CURRENT_LANG === 'ar') ? 'ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:'      : 'ğŸ“ Address:';
      var btnLabel   = (CURRENT_LANG === 'ar') ? 'Ø§Ø¶ØºØ· Ù„Ù„ØªÙˆØ¬ÙŠÙ‡'     : 'Open directions';
      var hoursHtml = '<p><span class="details-label">'+hoursLabel+'</span> '+(c.hours||'â€”')+'</p>';
      return ''+
        '<div class="hospital-popup">'+
          '<strong><i class="fas fa-hospital-alt"></i> '+ c.name +'</strong>'+
          '<p><span class="details-label">'+addrLabel+'</span> '+ (c.address||'â€”') +'</p>'+
            hoursHtml + phoneHtml +
          '<a class="go-map-btn" href="'+ link +'" target="_blank" rel="noopener"><i class="fas fa-route"></i> '+btnLabel+'</a>'+
        '</div>';
    }

    var map = L.map('mapid').setView([JEDDAH_LAT, JEDDAH_LNG], DEFAULT_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap contributors'}).addTo(map);
    var redMarker = L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});
    var blueMarker = L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});

    function renderCenters(list){
      if (markersLayer){ markersLayer.clearLayers(); map.removeLayer(markersLayer); }
      markersLayer = L.layerGroup();
      (list||[]).forEach(function(c){
        L.marker([c.lat,c.lng],{icon:redMarker}).bindPopup(createPopupContent(c)).addTo(markersLayer);
      });
      markersLayer.addTo(map);
      document.getElementById('map-counter').textContent = list.length
        ? (CURRENT_LANG === 'ar' ? (list.length + ' Ù†ØªÙŠØ¬Ø©') : (list.length + ' result(s)'))
        : (CURRENT_LANG === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬' : 'No results');
    }

    fetch('/static/centers_jeddah.json')
      .then(r=>r.json())
      .then(list=>{
        BLOOD_CENTERS = list.map(c=>{
          if (!c.sector){ c.sector = (c.type || detectSector(c.name)); }
          return c;
        });
        FILTERED_CENTERS = BLOOD_CENTERS.slice();
        renderCenters(FILTERED_CENTERS);
      })
      .catch(()=>{ displayError(CURRENT_LANG === 'ar'
        ? 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ².'
        : 'Failed to load centers list.'
      ); });

    var userLocation = null;

    document.getElementById('locate-center-btn').addEventListener('click', function(){
      var btn = document.getElementById('locate-center-btn');
      var lbl = document.getElementById('locate-center-label');
      if(lbl){
        lbl.innerText = (CURRENT_LANG === 'ar')
          ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...'
          : 'Detecting your location...';
      }
      btn.disabled = true;
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){
          var userLat = pos.coords.latitude, userLng = pos.coords.longitude;
          userLocation = [userLat, userLng];
          L.marker(userLocation,{icon:blueMarker}).addTo(map).bindPopup(
            (CURRENT_LANG === 'ar') ? 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ' : 'Your location'
          ).openPopup();
          map.setView(userLocation, 13);
          if(lbl){
            lbl.innerText = (CURRENT_LANG === 'ar')
              ? 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­'
              : 'Location detected';
          }
          btn.disabled = false;
          displayMessage(
            (CURRENT_LANG === 'ar')
              ? 'ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ.'
              : 'ğŸ“ Your location has been detected.',
            'bot'
          );
        }, function(){
          if(lbl){
            lbl.innerText = (CURRENT_LANG === 'ar')
              ? 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø¹Ø±Ø¶ Ø¬Ø¯Ø©)'
              : 'Failed to detect location (showing Jeddah)';
          }
          btn.disabled = false;
          displayError(
            (CURRENT_LANG === 'ar')
              ? 'âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ. ÙŠØ±Ø¬Ù‰ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„Ù…ØªØµÙØ­.'
              : 'âš ï¸ Failed to detect your location. Please allow location access.'
          );
        }, {enableHighAccuracy:true,timeout:10000,maximumAge:0});
      }else{
        if(lbl){
          lbl.innerText = (CURRENT_LANG === 'ar')
            ? 'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'
            : 'Your browser does not support geolocation';
        }
        btn.disabled = false;
        displayError(
          (CURRENT_LANG === 'ar')
            ? 'âŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø§ØµÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.'
            : 'âŒ Your browser does not support geolocation.'
        );
      }
    });

    function openNearestAuto(){
      function go(fromLat, fromLng){
        if (!FILTERED_CENTERS.length){
          displayError(CURRENT_LANG === 'ar'
            ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§ÙƒØ² Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.'
            : 'No matching centers at the moment.');
          return;
        }
        var n = findNearest([fromLat, fromLng]); if(!n) return;
        var url = gmapsDirections(fromLat,fromLng,n.lat,n.lng);
        window.location.href = url;
      }
      if(userLocation){ return go(userLocation[0], userLocation[1]); }
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){ go(pos.coords.latitude,pos.coords.longitude); },
          function(){ displayError(CURRENT_LANG === 'ar'
            ? 'Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„ÙØªØ­ Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ².'
            : 'Allow location access to open the nearest center.'
          ); },
          {enableHighAccuracy:true,timeout:8000});
      }
    }

    document.getElementById('map-nearest').addEventListener('click', function(){
      function go(fromLat, fromLng){
        if (!FILTERED_CENTERS || !FILTERED_CENTERS.length){
          displayError(CURRENT_LANG === 'ar'
            ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§ÙƒØ² Ù…Ø·Ø§Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠØ§. Ø£Ø¹Ø¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø£Ùˆ ÙˆØ³Ù‘Ø¹ Ø§Ù„Ø¨Ø­Ø«.'
            : 'No matching centers. Reset or broaden your filters.'
          );
          return;
        }
        var n = findNearest([fromLat, fromLng]);
        if(!n){
          displayError(CURRENT_LANG === 'ar'
            ? 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ².'
            : 'Could not determine the nearest center.'
          );
          return;
        }
        var url = gmapsDirections(fromLat, fromLng, n.lat, n.lng);
        window.location.href = url;
      }
      if (userLocation){
        go(userLocation[0], userLocation[1]);
      } else if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          function(pos){ go(pos.coords.latitude, pos.coords.longitude); },
          function(){ displayError(CURRENT_LANG === 'ar'
            ? 'Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…ÙˆÙ‚Ø¹Ùƒ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ².'
            : 'Allow your browser to access location to use nearest center.'
          ); },
          {enableHighAccuracy:true,timeout:8000}
        );
      } else {
        displayError(
          (CURRENT_LANG === 'ar')
            ? 'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.'
            : 'Your browser does not support geolocation.'
        );
      }
    });

    function normalize(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
    function applyMapFilters(){
      const q = normalize(document.getElementById('map-search').value);
      const sector = document.getElementById('map-sector').value;
      FILTERED_CENTERS = BLOOD_CENTERS.filter(c=>{
        const hay = normalize((c.name||'')+' '+(c.address||''));
        const matchText = !q || hay.indexOf(q) !== -1;
        const s = (c.sector||'').toLowerCase();
        const matchSector = !sector || s === sector;
        return matchText && matchSector;
      });
      renderCenters(FILTERED_CENTERS);
      if (FILTERED_CENTERS.length){
        const avgLat = FILTERED_CENTERS.reduce((a,c)=>a+c.lat,0)/FILTERED_CENTERS.length;
        const avgLng = FILTERED_CENTERS.reduce((a,c)=>a+c.lng,0)/FILTERED_CENTERS.length;
        map.setView([avgLat,avgLng], 12);
      }
    }
    document.getElementById('map-apply').addEventListener('click', applyMapFilters);
    document.getElementById('map-reset').addEventListener('click', function(){
      document.getElementById('map-search').value='';
      document.getElementById('map-sector').value='';
      FILTERED_CENTERS = BLOOD_CENTERS.slice();
      renderCenters(FILTERED_CENTERS);
      map.setView([JEDDAH_LAT, JEDDAH_LNG], DEFAULT_ZOOM);
    });
    document.getElementById('map-search').addEventListener('keydown', function(e){
      if(e.key==='Enter'){ applyMapFilters(); }
    });
    document.getElementById('map-sector').addEventListener('change', applyMapFilters);

    function emailValid(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim()); }
    function addReminderFallbackUI(next_date){
      const cb = document.getElementById('chat-box');
      const wrap = document.createElement('div');
      wrap.className = 'message bot-message';
      const baseText = (CURRENT_LANG === 'ar')
        ? 'ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯:'
        : 'You can also save the date:';
      const msg = encodeURIComponent(
        (CURRENT_LANG === 'ar'
          ? `ØªØ°ÙƒÙŠØ± Ø²Ù…Ø±Ø©: Ù…ÙˆØ¹Ø¯ ØªØ¨Ø±Ø¹Ùƒ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø¨ØªØ§Ø±ÙŠØ® ${next_date}.`
          : `Zomrah reminder: your suggested donation date is ${next_date}.`
        )
      );
      const wa = `https://wa.me/?text=${msg}`;
      const icsHref = `/api/reminder/ics/${next_date}`;
      const icsLabel = (CURRENT_LANG === 'ar')
        ? 'ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªÙ‚ÙˆÙŠÙ… (.ics)'
        : 'Download calendar file (.ics)';
      const waLabel = (CURRENT_LANG === 'ar')
        ? 'Ø£Ø±Ø³Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨'
        : 'Send reminder via WhatsApp';
      wrap.innerHTML = `
        <div>${baseText}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
          <a class="go-map-btn" href="${icsHref}" download>${icsLabel}</a>
          <a class="go-map-btn" href="${wa}" target="_blank" rel="noopener">${waLabel}</a>
        </div>
      `;
      cb.appendChild(wrap);
      cb.scrollTop = cb.scrollHeight;
    }

    var lastUserRaw = '';
    document.getElementById('user-input').addEventListener('keydown', function(e){
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('send-btn').click(); }
    });
    document.getElementById('send-btn').addEventListener('click', async function(){
      var inputField = document.getElementById('user-input');
      var rawMessage = (inputField.value||'').trim();
      if(!rawMessage) return;
      inputField.value = '';
      lastUserRaw = rawMessage;

      var loadingDiv = null, data = null;
      try{
        setInteractionState(false); loadingDiv = showLoading();
        var res = await fetch('/api/chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message:rawMessage, lang: CURRENT_LANG})
        });
        if(!res.ok) throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: '+res.status+' '+res.statusText);
        data = await res.json();
      }catch(err){
        displayError(
          (CURRENT_LANG === 'ar')
            ? ('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message + '. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø®Ø§Ø¯Ù… Flask ÙŠØ¹Ù…Ù„.')
            : ('âŒ Connection failed: ' + err.message + '. Check that the Flask server is running.')
        );
        removeLoading(loadingDiv); setInteractionState(true); return;
      }finally{
        removeLoading(loadingDiv); setInteractionState(true);
      }

     if (data) {
  // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø¹Ø±Ø¶ Ù…Ø§ ÙƒØªØ¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„
  var finalUserMessage = rawMessage;

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© Ùˆ Ø§Ù„Ø¨Ø§Ùƒ ØµÙ„Ø­ Ø§Ù„Ø³Ø¤Ø§Ù„ â†’ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ù‘Ø­Ø©
  if (CURRENT_LANG === 'ar' && data.corrected_message) {
    finalUserMessage = data.corrected_message;
  }

  displayMessage(finalUserMessage, 'user');
  displayAnswerWithControls(data.answer || '', finalUserMessage);

  if (isLocationIntent(rawMessage)) {
    openNearestAuto();
  }
}

    });

    function pill(id, group, value, label){
      return `<span class="pill" id="${id}" data-group="${group}" data-value="${value}">${label}</span>`;
    }

    function buildEligibilityUI(){
      const cb = document.getElementById('chat-box');
      const m = document.createElement('div');
      m.className = 'message bot-message';

      if (CURRENT_LANG === 'ar') {
        m.innerHTML = `
        <div style="font-weight:800;margin-bottom:8px;">Ù†Ù…ÙˆØ°Ø¬ ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</div>

        <div class="elig-row">
          <label>Ø§Ù„Ù†ÙˆØ¹:</label>
          ${pill('g-m','gender','male','Ø°ÙƒØ±')}
          ${pill('g-f','gender','female','Ø£Ù†Ø«Ù‰')}
        </div>

        <div class="elig-row">
          <label>Ø§Ù„Ø¹Ù…Ø± (Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª):</label>
          <input id="age" type="number" class="elig-input" min="1" max="100" placeholder="Ù…Ø«Ø§Ù„: 25"/>
        </div>

        <div class="elig-row">
          <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…):</label>
          <input id="weight" type="number" class="elig-input" min="30" max="300" placeholder="Ù…Ø«Ø§Ù„: 60"/>
        </div>

        <div class="elig-row">
          <label>Ø¢Ø®Ø± ØªØ¨Ø±Ø¹ (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…):</label>
          <input id="last_donation_days" type="number" class="elig-input" min="0" max="2000" placeholder="Ù…Ø«Ø§Ù„: 100"/>
        </div>

        <div class="elig-row">
          <label>Ø£Ø¯ÙˆÙŠØ© Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ø¯Ù…ØŸ</label>
          ${pill('ac-y','on_ac','yes','Ù†Ø¹Ù…')}${pill('ac-n','on_ac','no','Ù„Ø§')}
        </div>

        <div class="elig-row">
          <label>Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ Ù„Ø¹Ø¯ÙˆÙ‰ Ù†Ø´Ø·Ø©ØŸ</label>
          ${pill('ab-y','on_ac2','yes','Ù†Ø¹Ù…')}${pill('ab-n','on_ac2','no','Ù„Ø§')}
        </div>

        <div class="elig-row">
          <label>Ø£Ø¹Ø±Ø§Ø¶ Ø²ÙƒØ§Ù…/Ø­Ù…Ù‰ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŸ</label>
          ${pill('cold-y','cold','yes','Ù†Ø¹Ù…')}${pill('cold-n','cold','no','Ù„Ø§')}
        </div>

        <div class="elig-row only-female" style="display:none;">
          <label>Ù‡Ù„ Ø£Ù†ØªÙ Ø­Ø§Ù…Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŸ</label>
          ${pill('preg-y','pregnant','yes','Ù†Ø¹Ù…')}${pill('preg-n','pregnant','no','Ù„Ø§')}
        </div>

        <div class="elig-row">
          <label>Ù‡Ù„ Ø£Ø¬Ø±ÙŠØª Ø¹Ù…Ù„ÙŠØ©/Ù‚Ù„Ø¹ Ø£Ø³Ù†Ø§Ù† Ù…Ø¤Ø®Ø±Ù‹Ø§ØŸ</label>
          ${pill('proc-y','procedure','yes','Ù†Ø¹Ù…')}${pill('proc-n','procedure','no','Ù„Ø§')}
        </div>
        <div class="elig-row" id="procedure-days-row" style="display:none;">
          <label>ÙƒÙ… ÙŠÙˆÙ… Ù…Ø¶Ù‰ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø¥Ø¬Ø±Ø§Ø¡/Ù‚Ù„Ø¹ Ø£Ø³Ù†Ø§Ù†ØŸ</label>
          <input id="recent_procedure_days" type="number" class="elig-input" min="0" max="400" placeholder="Ù…Ø«Ø§Ù„: 14"/>
        </div>

        <div class="elig-row">
          <label>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ ÙˆØ´Ù…/Ø«Ù‚Ø¨ Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©ØŸ</label>
          ${pill('tat-y','tattoo','yes','Ù†Ø¹Ù…')}${pill('tat-n','tattoo','no','Ù„Ø§')}
        </div>
        <div class="elig-row" id="tattoo-months-row" style="display:none;">
          <label>Ù‚Ø¨Ù„ ÙƒÙ… Ø´Ù‡Ø± ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ ÙƒØ§Ù† Ø¢Ø®Ø± ÙˆØ´Ù…/Ø«Ù‚Ø¨ØŸ</label>
          <input id="tattoo_months" type="number" class="elig-input" min="0" max="48" placeholder="Ù…Ø«Ø§Ù„: 6"/>
        </div>

        <div class="elig-row" style="margin-top:10px;">
          <button id="elig-submit" class="go-map-btn"><i class="fas fa-check"></i> Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</button>
        </div>

        <div id="elig-result" class="elig-result"><span class="muted">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· "Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø£Ù‡Ù„ÙŠØ©".</span></div>
      `;
      } else {
        m.innerHTML = `
        <div style="font-weight:800;margin-bottom:8px;">Eligibility check form</div>

        <div class="elig-row">
          <label>Gender:</label>
          ${pill('g-m','gender','male','Male')}
          ${pill('g-f','gender','female','Female')}
        </div>

        <div class="elig-row">
          <label>Age (years):</label>
          <input id="age" type="number" class="elig-input" min="1" max="100" placeholder="e.g. 25"/>
        </div>

        <div class="elig-row">
          <label>Weight (kg):</label>
          <input id="weight" type="number" class="elig-input" min="30" max="300" placeholder="e.g. 60"/>
        </div>

        <div class="elig-row">
          <label>Last donation (days ago):</label>
          <input id="last_donation_days" type="number" class="elig-input" min="0" max="2000" placeholder="e.g. 100"/>
        </div>

        <div class="elig-row">
          <label>On blood thinners?</label>
          ${pill('ac-y','on_ac','yes','Yes')}${pill('ac-n','on_ac','no','No')}
        </div>

        <div class="elig-row">
          <label>On antibiotics for active infection?</label>
          ${pill('ab-y','on_ac2','yes','Yes')}${pill('ab-n','on_ac2','no','No')}
        </div>

        <div class="elig-row">
          <label>Cold/fever symptoms now?</label>
          ${pill('cold-y','cold','yes','Yes')}${pill('cold-n','cold','no','No')}
        </div>

        <div class="elig-row only-female" style="display:none;">
          <label>Currently pregnant? (for women)</label>
          ${pill('preg-y','pregnant','yes','Yes')}${pill('preg-n','pregnant','no','No')}
        </div>

        <div class="elig-row">
          <label>Recent surgery / tooth removal?</label>
          ${pill('proc-y','procedure','yes','Yes')}${pill('proc-n','procedure','no','No')}
        </div>
        <div class="elig-row" id="procedure-days-row" style="display:none;">
          <label>How many days ago was the last procedure?</label>
          <input id="recent_procedure_days" type="number" class="elig-input" min="0" max="400" placeholder="e.g. 14"/>
        </div>

        <div class="elig-row">
          <label>Tattoo / piercing recently?</label>
          ${pill('tat-y','tattoo','yes','Yes')}${pill('tat-n','tattoo','no','No')}
        </div>
        <div class="elig-row" id="tattoo-months-row" style="display:none;">
          <label>Roughly how many months ago?</label>
          <input id="tattoo_months" type="number" class="elig-input" min="0" max="48" placeholder="e.g. 6"/>
        </div>

        <div class="elig-row" style="margin-top:10px;">
          <button id="elig-submit" class="go-map-btn"><i class="fas fa-check"></i> Check eligibility</button>
        </div>

        <div id="elig-result" class="elig-result"><span class="muted">Fill the form and click "Check eligibility".</span></div>
      `;
      }

      cb.appendChild(m);
      cb.scrollTop = cb.scrollHeight;
    }

    document.addEventListener('click', function(e){
      if (e.target && e.target.classList.contains('pill')) {
        const g = e.target.dataset.group;
        document.querySelectorAll('.pill[data-group="'+g+'"]').forEach(p=>p.classList.remove('active'));
        e.target.classList.add('active');

        if (g === 'gender') {
          const v = e.target.dataset.value;
          const fem = document.querySelector('.only-female');
          if (fem) fem.style.display = (v === 'female') ? 'block' : 'none';
        }

        if (g === 'procedure') {
          const v = e.target.dataset.value;
          const row = document.getElementById('procedure-days-row');
          if (row) row.style.display = (v === 'yes') ? 'block' : 'none';
        }

        if (g === 'tattoo') {
          const v = e.target.dataset.value;
          const row = document.getElementById('tattoo-months-row');
          if (row) row.style.display = (v === 'yes') ? 'block' : 'none';
        }
      }
    });

    document.getElementById('eligibility-flow-btn').addEventListener('click', function(){
      buildEligibilityUI();
    });

    document.addEventListener('click', async function(e){
      if (e.target && e.target.id === 'elig-submit') {
        const gActive = document.querySelector('.pill[data-group="gender"].active');
        const g = gActive ? gActive.dataset.value : null;

        const age    = parseInt(document.getElementById('age')?.value || '0', 10);
        const weight = parseInt(document.getElementById('weight')?.value || '0', 10);
        const last   = parseInt(document.getElementById('last_donation_days')?.value || '9999', 10);

        const getYN = (grp)=> {
          const a = document.querySelector('.pill[data-group="'+grp+'"].active');
          return a ? (a.dataset.value === 'yes') : false;
        };
        const on_ac = getYN('on_ac');
        const on_ab = getYN('on_ac2');
        const cold  = getYN('cold');
        let pregnant = false;
        if (g === 'female') pregnant = getYN('pregnant');

        const procYes = getYN('procedure');
        const tattooYes = getYN('tattoo');

        const recent = procYes
          ? parseInt(document.getElementById('recent_procedure_days')?.value || '0', 10)
          : 9999; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ø­Ø¯ÙŠØ«

        const tattoo = tattooYes
          ? parseInt(document.getElementById('tattoo_months')?.value || '0', 10)
          : 999; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ´Ù… Ø®Ù„Ø§Ù„ ÙØªØ±Ø© Ù‚Ø±ÙŠØ¨Ø©

        const payload = {
          age, weight, last_donation_days:last,
          on_anticoagulants:on_ac,
          on_antibiotics:on_ab,
          has_cold:cold,
          pregnant,
          recent_procedure_days:recent,
          tattoo_months:tattoo
        };

        try{
          const r = await fetch('/api/eligibility/evaluate',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!r.ok) throw new Error('HTTP '+r.status);
          const j = await r.json();
          const box = document.getElementById('elig-result');
          if (!box) return;

          const ok = !!j.eligible;
          const reasons = j.reasons || [];
          const nextd = j.next_eligible_date || '-';

          box.className = 'elig-result ' + (ok ? 'ok' : 'bad');

          const title = ok
            ? (CURRENT_LANG === 'ar' ? 'âœ… Ù…Ø¤Ù‡Ù„ Ù„Ù„ØªØ¨Ø±Ø¹ Ø­Ø§Ù„ÙŠØ§Ù‹' : 'âœ… Eligible to donate now')
            : (CURRENT_LANG === 'ar' ? 'â›” ØºÙŠØ± Ù…Ø¤Ù‡Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹'      : 'â›” Not currently eligible');
          const nextLabel = (CURRENT_LANG === 'ar')
            ? 'ğŸ—“ï¸ Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…Ù†Ø§Ø³Ø¨: '
            : 'ğŸ—“ï¸ Next suitable date: ';

          let html = `
            <div><strong>${title}</strong></div>
            <div>${nextLabel}<strong>${nextd}</strong></div>
          `;
          if (reasons.length){
            html += '<ul style="margin:8px 16px 0 0">';
            reasons.forEach(rsn=>{
              html += '<li>'+ rsn +'</li>'; // Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
            });
            html += '</ul>';
          } else {
            html += (CURRENT_LANG === 'ar')
              ? '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù†Ø¹ ÙˆØ§Ø¶Ø­Ø©.</div>'
              : '<div class="muted">No clear contraindications.</div>';
          }

          box.innerHTML = html;
        }catch(err){
          displayError(
            (CURRENT_LANG === 'ar')
              ? ('ØªØ¹Ø°Ù‘Ø± ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ù‡Ù„ÙŠØ©: '+err.message)
              : ('Could not evaluate eligibility: '+err.message)
          );
        }
      }
    });

    document.getElementById('reminder-btn').addEventListener('click', async function(){
      const who = (prompt(CURRENT_LANG === 'ar'
        ? 'Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):'
        : 'Your name (optional):'
      ) || 'User').trim();
      const email = (prompt(CURRENT_LANG === 'ar'
        ? 'Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ°ÙƒÙŠØ± (Ù…Ø«Ø§Ù„: name@example.com):'
        : 'Enter your email to receive a reminder (e.g. name@example.com):'
      ) || '').trim();

      if (!emailValid(email)){
        displayError(
          (CURRENT_LANG === 'ar')
            ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­.'
            : 'Please enter a valid email address.'
        );
        return;
      }

      try{
        const r = await fetch('/api/reminder',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({user_hint:who, email})
        });
        const j = await r.json();
        if(!j.ok){
          displayError(
            (CURRENT_LANG === 'ar')
              ? 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ±.'
              : 'Reminder was not saved.'
          );
          return;
        }

        if (j.email_status && j.email_status.sent){
          displayMessage(
            (CURRENT_LANG === 'ar'
              ? 'ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. Ù…ÙˆØ¹Ø¯Ùƒ Ø§Ù„Ù…Ù‚ØªØ±Ø­: '
              : 'ğŸ“© A reminder was sent to your email. Suggested date: '
            ) + j.next_date,
            'bot'
          );
        } else {
          const msg = j.email_status && j.email_status.message ? j.email_status.message : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
          displayError(
            (CURRENT_LANG === 'ar'
              ? ('ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ('+ msg +').')
              : ('Failed to send email ('+ msg +').')
            )
          );
          displayMessage(
            (CURRENT_LANG === 'ar'
              ? 'ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ø·Ø±Ù‚ Ø¨Ø¯ÙŠÙ„Ø© Ø£Ø¯Ù†Ø§Ù‡:'
              : 'You can still save the date using the options below:'
            ),
            'bot'
          );
        }

        addReminderFallbackUI(j.next_date);
      }catch(e){
        displayError(
          (CURRENT_LANG === 'ar')
            ? 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ°ÙƒÙŠØ±.'
            : 'Error while creating the reminder.'
        );
      }
    });

    document.getElementById('urgent-needs-btn').addEventListener('click', async function(){
      const cb = document.getElementById('chat-box');
      const loading = document.createElement('div');
      loading.className = 'message bot-message loading-message';
      loading.textContent = (CURRENT_LANG === 'ar')
        ? 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª...'
        : 'Fetching urgent blood needs from hospitals...';
      cb.appendChild(loading);
      cb.scrollTop = cb.scrollHeight;

      try{
        const res = await fetch('/api/urgent_needs?lang='+CURRENT_LANG);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j = await res.json();
        cb.removeChild(loading);

        const wrap = document.createElement('div');
        wrap.className = 'message bot-message';
        let html = `<div style="font-weight:800;margin-bottom:6px;">${
          CURRENT_LANG === 'ar'
            ? 'Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ Ù„Ù„Ø¯Ù… (Ø¬Ø¯Ø© ÙˆÙ…Ø§ Ø­ÙˆÙ„Ù‡Ø§)'
            : 'Urgent blood needs (Jeddah & nearby)'
        }</div>`;

        const note = (CURRENT_LANG === 'ar') ? (j.answer_ar || '') : (j.answer_en || j.answer_ar || '');
        if(note){
          html += `<div class="inline-note" style="margin-bottom:8px;">${note}</div>`;
        }
        html += `<div class="urgent-wrapper">`;

        (j.needs || []).forEach(n=>{
          const status = (n.status || '').trim();
          let cls = 'normal';
          if (/Ø¹Ø§Ø¬Ù„|Ø·Ø§Ø±Ø¦|Ù…Ø±ØªÙØ¹ Ø¬Ø¯Ø§Ù‹|critical|urgent/i.test(status)) cls = 'critical';
          else if (/Ù…Ø±ØªÙØ¹|Ù…ØªÙˆØ³Ø·|high/i.test(status)) cls = 'high';

          const titlePrefix = 'ğŸ¥ ';
          const navBtnLabel = (CURRENT_LANG === 'ar')
            ? 'Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·'
            : 'Open in Maps';

          html += `
            <div class="urgent-card ${cls}" data-url="${n.location_url || ''}">
              <div class="title">${titlePrefix}${n.hospital || (CURRENT_LANG === 'ar' ? 'Ù…Ø³ØªØ´ÙÙ‰ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' : 'Unknown hospital')}</div>
              <div class="badge">${n.status || (CURRENT_LANG === 'ar' ? 'Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©' : 'Unspecified status')}</div>
              <div>ğŸ” ${n.details || (CURRENT_LANG === 'ar' ? 'ØªÙØ§ØµÙŠÙ„ ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±Ø©' : 'No details provided')}</div>
              ${n.location_url ? `<div style="margin-top:6px;"><button class="go-map-btn" type="button">${navBtnLabel}</button></div>` : ''}
            </div>
          `;
        });
        html += `</div>`;
        wrap.innerHTML = html;
        cb.appendChild(wrap);
        cb.scrollTop = cb.scrollHeight;

        wrap.querySelectorAll('.urgent-card').forEach(card=>{
          const url = card.getAttribute('data-url');
          if(!url) return;
          card.addEventListener('click', function(e){
            if(e.target && e.target.classList.contains('go-map-btn')){
              window.open(url, '_blank');
            }else{
              window.open(url, '_blank');
            }
          });
        });
      }catch(e){
        try{ cb.removeChild(loading); }catch(_){}
        displayError(
          (CURRENT_LANG === 'ar')
            ? ('ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„: '+e.message)
            : ('Could not fetch urgent needs: '+e.message)
        );
      }
    });

    const micBtn = document.getElementById('mic-btn');
    const audioInput = document.getElementById('audio-input');

    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    async function sendAudioBlob(blob, filename) {
      const loading = showLoading();
      try {
        const fd = new FormData();
        fd.append('audio_file', blob, filename || 'recording.webm');
        const res = await fetch('/api/upload_audio', {
          method:'POST',
          body: fd
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const j = await res.json();
        removeLoading(loading);

        displayMessage(
          (CURRENT_LANG === 'ar' ? 'ğŸ™ï¸ (Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©)' : 'ğŸ™ï¸ (voice message)'),
          'user'
        );
        displayAnswerWithControls(j.answer || '', j.corrected_message || j.transcribed_text || '');
      } catch(e) {
        removeLoading(loading);
        displayError(
          (CURRENT_LANG === 'ar')
            ? ('ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª: '+e.message)
            : ('Failed to process audio: '+e.message)
        );
      }
    }

    micBtn.addEventListener('click', async function(){
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        if (!isRecording) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => {
              if (e.data.size > 0) audioChunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
              const blob = new Blob(audioChunks, { type: 'audio/webm' });
              sendAudioBlob(blob, 'mic_recording.webm');
              stream.getTracks().forEach(t => t.stop());
            };
            mediaRecorder.start();
            isRecording = true;
            micBtn.classList.add('recording');
            micBtn.title = (CURRENT_LANG === 'ar') ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„' : 'Stop recording';
          } catch (err) {
            console.error(err);
            audioInput.click();
          }
        } else {
          isRecording = false;
          micBtn.classList.remove('recording');
          micBtn.title = (CURRENT_LANG === 'ar') ? 'Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØªÙŠ' : 'Send audio';
          if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
          }
        }
      } else {
        audioInput.click();
      }
    });

    audioInput.addEventListener('change', async function(){
      if (!this.files || !this.files.length) return;
      const file = this.files[0];
      const loading = showLoading();

      try {
        const fd = new FormData();
        fd.append('audio_file', file);
        const res = await fetch('/api/upload_audio', {
          method:'POST',
          body: fd
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j = await res.json();
        removeLoading(loading);

        displayMessage(
          (CURRENT_LANG === 'ar'
            ? ('ğŸ™ï¸ ('+ (file.name || 'Ù…Ù„Ù ØµÙˆØªÙŠ') +')')
            : ('ğŸ™ï¸ ('+ (file.name || 'audio file') +')')
          ),
          'user'
        );
        displayAnswerWithControls(j.answer || '', j.corrected_message || j.transcribed_text || '');
      } catch(e) {
        removeLoading(loading);
        displayError(
          (CURRENT_LANG === 'ar')
            ? ('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ: '+e.message)
            : ('Failed to upload audio file: '+e.message)
        );
      } finally {
        this.value = '';
      }
    });

    window.sendQuickQuestion = function(q){
      var f = document.getElementById('user-input');
      f.value = q;
      document.getElementById('send-btn').click();
    };
  </script>
</body>
</html>
