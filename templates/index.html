<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø²Ù…Ø±Ø© | Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø¯Ù…</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --primary-red:#B30000;--burgundy-dark:#800020;--primary-text:#333;--secondary-text:#666;
      --background-light:#F8F8F8;--card-background:#FFF;
      --gradient-hospital-btn:linear-gradient(to left,#A52A2A,#C04000);
      --gradient-urgent-btn:linear-gradient(to left,#800020,#B30000);
      --gradient-map-btn:linear-gradient(to left,#A52A2A,#C04000);
      --gradient-whatsapp-btn:linear-gradient(to left,#25D366,#3EDF7D);
      --gradient-header:linear-gradient(to right,#fff,#F4F4F4);
      --gradient-send:linear-gradient(to right,var(--burgundy-dark),var(--primary-red));
      --bot-bubble:#EBF2F7;--user-bubble:var(--primary-red);
      --shadow-subtle:0 4px 12px rgba(0,0,0,.08);
      --border-radius-lg:12px;--border-radius-sm:8px;
      --critical-red:#DC3545;--high-yellow:#FFC107;--low-blue:#17A2B8;
    }
    body{font-family:'Tajawal',sans-serif;background:var(--background-light);margin:0;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px;box-sizing:border-box;color:var(--primary-text)}
    .main-wrapper{display:flex;flex-direction:row-reverse;width:100%;max-width:1300px;gap:25px}
    .chat-container{flex:3;background:var(--card-background);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-subtle);display:flex;flex-direction:column;overflow:hidden;min-height:700px}
    .sidebar-container{flex:1.2;display:flex;flex-direction:column;gap:20px}
    .sidebar-box{background:var(--card-background);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-subtle);padding:16px;display:flex;flex-direction:column;gap:10px}
    .sidebar-box h2{color:var(--burgundy-dark);font-size:1.2em;font-weight:800;margin:0;padding-bottom:10px;border-bottom:2px solid #EEE}
    .sidebar-btn{display:flex;flex-direction:row-reverse;align-items:center;gap:12px;padding:14px;border-radius:var(--border-radius-sm);text-decoration:none;color:#fff;transition:all .2s;border:none;cursor:pointer;min-height:54px;box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .sidebar-btn.hospital{background-image:var(--gradient-hospital-btn)}
    .sidebar-btn.urgent{background-image:var(--gradient-urgent-btn)}
    .sidebar-btn.map{background-image:var(--gradient-map-btn)}
    .sidebar-btn.whatsapp{background-image:var(--gradient-whatsapp-btn)}
    .sidebar-btn .icon{font-size:1.4em;color:#fff;font-weight:900}
    .sidebar-btn .label{font-weight:800;font-size:.98em;flex-grow:1;text-align:right}
    .sidebar-btn:hover:not(:disabled){transform:translateY(-1px);opacity:.95}
    .sidebar-btn:disabled{cursor:not-allowed;opacity:.6}

    header{background:var(--gradient-header);padding:16px;border-bottom:1px solid #E0E0E0;text-align:right}
    header h1{font-size:1.4em;margin:0;color:var(--burgundy-dark);font-weight:800;display:flex;align-items:center;flex-direction:row-reverse;justify-content:flex-end;gap:10px}

    #chat-box{flex-grow:1;padding:18px 20px;overflow-y:auto;background:#FAFAFA;display:flex;flex-direction:column}
    .message{padding:12px 16px;margin-bottom:12px;border-radius:var(--border-radius-lg);max-width:72%;line-height:1.7;font-size:.95em;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .bot-message{background:var(--bot-bubble);align-self:flex-start;border-bottom-left-radius:6px}
    .user-message{background:var(--user-bubble);color:#fff;align-self:flex-end;border-bottom-right-radius:6px}
    .loading-message{font-weight:800;color:var(--secondary-text);background:#F0F0F0}
    .error-message{color:#b00;font-weight:800}

    .input-area{display:flex;padding:12px 16px;border-top:1px solid #E0E0E0;background:var(--card-background)}
    #user-input{flex-grow:1;padding:11px 14px;border:2px solid var(--primary-red);border-radius:12px;margin-inline-end:10px;font-size:1em}
    #user-input:focus{outline:none;border-color:var(--burgundy-dark)}
    #send-btn{background:var(--gradient-send);color:#fff;border:none;padding:11px 24px;border-radius:12px;cursor:pointer;font-size:1em;font-weight:800}

    .translation-block{margin-top:10px}
    .toggle-btn,.helper-btn{margin-top:8px;background:#fff;border:1px solid #ddd;border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:800}
    .inline-note{font-size:.9em;color:var(--secondary-text);margin-top:6px}

    .faq-list{display:flex;flex-direction:column;gap:8px}
    .faq-item{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:800}
    .faq-item:hover{background:#fff}

    .go-map-btn{display:inline-block;margin-top:8px;padding:8px 12px;border-radius:10px;background:linear-gradient(to left,#800020,#B30000);color:#fff;text-decoration:none;font-weight:800;border:none;box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .go-map-btn:hover{opacity:.95}

    .map-filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:10px;border-top:1px solid #eee;background:#fff}
    .map-filters input,.map-filters select{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-family:inherit}
    .map-filters .counter{font-size:.9em;color:#555;margin-inline-start:auto}

    .urgent-needs-wrapper .urgent-card{padding:12px;margin-bottom:10px;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.05);border-right:5px solid}
    .urgent-card.critical{border-color:#DC3545;background:#FFF0F0}
    .urgent-card.high{border-color:#FFC107;background:#FFF9E0}
    .urgent-card.low{border-color:#17A2B8;background:#E0F7FA}
    .urgent-card .status{display:inline-block;margin-top:6px;padding:2px 8px;border-radius:8px;font-weight:800}
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="chat-container">
      <header>
        <h1>Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø²Ù…Ø±Ø© <span class="blood-drop">ğŸ©¸</span></h1>
      </header>

      <div id="chat-box">
        <div class="message bot-message">
          Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <strong style="color:var(--primary-red);font-weight:800;">Ø²Ù…Ø±Ø©</strong> â€” Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.
          <div class="translation-block">
            <button class="toggle-btn" onclick="toggleNext(this)">Show English translation</button>
            <div class="ar-translation" style="display:none;margin-top:6px;direction:ltr;text-align:left;">
              Welcome to <strong style="color:#B30000;font-weight:800;">Zomrah</strong>.
            </div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." autofocus/>
        <button id="send-btn"><i class="fa-solid fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>

    <div class="sidebar-container">
      <div class="sidebar-box" style="padding:0;overflow:hidden;border-radius:12px;">
        <div id="mapid" style="height:230px;"></div>
        <button class="sidebar-btn hospital" id="locate-center-btn" style="border-radius:0;margin:0;width:100%;">
          <i class="fas fa-map-pin icon"></i><span class="label">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ ÙˆØ£Ø¸Ù‡Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ²</span>
        </button>
        <div class="map-filters">
          <input id="map-search" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ø§Ù„Ø­ÙŠ..." />
          <select id="map-sector">
            <option value="">Ø§Ù„Ù‚Ø·Ø§Ø¹: Ø§Ù„ÙƒÙ„</option>
            <option value="public">Ø­ÙƒÙˆÙ…ÙŠ ÙÙ‚Ø·</option>
            <option value="private">Ø®Ø§Øµ ÙÙ‚Ø·</option>
          </select>
          <button id="map-apply" class="helper-btn">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="map-reset" class="helper-btn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
          <button id="map-nearest" class="go-map-btn"><i class="fa-solid fa-route"></i> Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„Ø¢Ù†</button>
          <div class="counter" id="map-counter">â€”</div>
        </div>
      </div>

      <button class="sidebar-btn urgent" id="urgent-needs-btn">
        <i class="fas fa-exclamation-triangle icon"></i>
        <span class="label">Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ Ù„Ù„Ø¯Ù…</span>
      </button>

      <button class="sidebar-btn map" id="eligibility-flow-btn">
        <i class="fas fa-clipboard-check icon"></i>
        <span class="label">ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</span>
      </button>

      <button class="sidebar-btn map" id="reminder-btn">
        <i class="fas fa-bell icon"></i>
        <span class="label">ØªØ°ÙƒÙŠØ± Ø¨Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ¨Ø±Ø¹</span>
      </button>

      <a class="sidebar-btn whatsapp" target="_blank" rel="noopener"
         href="https://wa.me/966504635135?text=%D8%A3%D9%87%D9%84%D8%A7%D9%8B%D8%8C%20%D8%A3%D8%B1%D9%8A%D8%AF%20%D8%A7%D9%84%D8%A7%D8%B3%D8%AA%D9%81%D8%B3%D8%A7%D8%B1%20%D8%B9%D9%86%20%D8%AE%D8%AF%D9%85%D8%A9%20%D8%B2%D9%85%D8%B1%D8%A9.">
        <i class="fab fa-whatsapp icon"></i><span class="label">ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø± (ÙˆØ§ØªØ³Ø§Ø¨)</span>
      </a>

      <div class="sidebar-box">
        <h2>â“ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø´Ø§Ø¦Ø¹Ø©</h2>
        <div class="faq-list">
          <div class="faq-item" onclick="sendQuickQuestion('Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…ØŸ')">Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¨Ø±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
          <div class="faq-item" onclick="sendQuickQuestion('Ù…ØªÙ‰ Ø£Ù‚Ø¯Ø± Ø£ØªØ¨Ø±Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ')">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙØ§ØµÙ„Ø© Ø¨ÙŠÙ† Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª</div>
          <div class="faq-item" onclick="sendQuickQuestion('Ù‡Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù… Ù…Ø¤Ù„Ù…ØŸ')">Ø§Ù„Ø¢Ø«Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ù…Ø®Ø§ÙˆÙ</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== 0) ÙØ­Øµ SMTP ===== */
    let SMTP_READY = false;
    fetch('/health').then(r=>r.json()).then(j=>{ SMTP_READY = !!j.smtp_ready; }).catch(()=>{});

    /* ===== 1) Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ===== */
    function toggleNext(btn){
      var el = btn.nextElementSibling; if(!el) return;
      var shown = el.style.display !== 'none';
      el.style.display = shown ? 'none' : 'block';
      btn.textContent = shown ? 'Show English translation' : 'Hide English translation';
    }
    function showLoading(){
      var box = document.getElementById('chat-box');
      var d = document.createElement('div'); d.className='message bot-message loading-message'; d.id='loading-indicator';
      d.textContent='Ø²Ù…Ø±Ø© ØªÙƒØªØ¨... ğŸ§ '; box.appendChild(d); box.scrollTop=box.scrollHeight; return d;
    }
    function removeLoading(d){ if(d && d.parentNode) d.parentNode.removeChild(d); }
    function displayMessage(text, who){
      var box=document.getElementById('chat-box');
      var d=document.createElement('div'); d.className='message '+(who==='user'?'user-message':'bot-message');
      d.innerHTML = (text||'').replace(/\n/g,'<br>');
      box.appendChild(d); box.scrollTop=box.scrollHeight;
    }
    function displayError(text){ displayMessage('<span class="error-message">'+text+'</span>','bot'); }
    function setInteractionState(enabled){
      ['send-btn','user-input','urgent-needs-btn','locate-center-btn','eligibility-flow-btn','reminder-btn'].forEach(function(id){
        var el=document.getElementById(id); if(el) el.disabled=!enabled;
      });
      document.querySelectorAll('.faq-item').forEach(function(x){ x.style.pointerEvents='auto'; x.style.opacity='1'; });
    }

    /* ===== 2) ÙÙ‚Ø§Ø¹Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø¯Ø¯ ===== */
    function displayAnswerWithControls(summarizedText, originalQuestion){
      var cb=document.getElementById('chat-box');
      var m=document.createElement('div'); m.className='message bot-message';
      var main=document.createElement('div'); main.className='ar-text';
      main.innerHTML=(summarizedText||'').replace(/\n/g,'<br>'); m.appendChild(main);

      var btn=document.createElement('button'); btn.className='helper-btn'; btn.textContent='ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±';
      btn.dataset.state='collapsed'; btn.dataset.summarized=summarizedText||''; btn.dataset.question=originalQuestion||'';
      m.appendChild(btn);

      var tr=document.createElement('div'); tr.className='translation-block';
      tr.innerHTML='<button class="toggle-btn" onclick="toggleNext(this)">Show English translation</button><div class="ar-translation" style="display:none;margin-top:6px;direction:ltr;text-align:left;">(English translation appears here)</div>';
      m.appendChild(tr);

      btn.addEventListener('click', async function(){
        if(this.dataset.state==='collapsed'){
          if(!this.dataset.detailed){
            try{
              const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:this.dataset.question||'',detail:true})});
              if(!res.ok) throw new Error('HTTP '+res.status);
              const j=await res.json(); this.dataset.detailed=j.answer||this.dataset.summarized;
            }catch(e){ displayError('âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„.'); return; }
          }
          main.innerHTML=(this.dataset.detailed||'').replace(/\n/g,'<br>');
          this.textContent='Ø¥Ø¸Ù‡Ø§Ø± Ø£Ù‚Ù„'; this.dataset.state='expanded';
        } else {
          main.innerHTML=(this.dataset.summarized||'').replace(/\n/g,'<br>');
          this.textContent='ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±'; this.dataset.state='collapsed';
        }
      });

      cb.appendChild(m); cb.scrollTop=cb.scrollHeight;
    }

    /* ===== 3) Ù†ÙŠØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ===== */
    const LOCATION_RE=/(Ù…ÙˆÙ‚Ø¹|Ø§Ù„Ù…ÙˆÙ‚Ø¹|Ø£Ù‚Ø±Ø¨|Ù‚Ø±ÙŠØ¨|Ø§Ù„Ø®Ø±Ø§Ø¦Ø·|Ø§Ù„Ø®Ø±ÙŠØ·Ø©|map|nearest|location|directions|ÙˆÙŠÙ†|Ø§Ù‚Ø±Ø¨)/i;
    function isLocationIntent(t){ return LOCATION_RE.test((t||'').trim()); }

    /* ===== 4) Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===== */
    var JEDDAH_LAT=21.5433, JEDDAH_LNG=39.1728, DEFAULT_ZOOM=11;
    var BLOOD_CENTERS=[], FILTERED_CENTERS=[], markersLayer=null, userLocation=null;

    function gmapsDirections(fromLat,fromLng,toLat,toLng){
      return 'https://www.google.com/maps/dir/?api=1&origin='+fromLat+','+fromLng+'&destination='+toLat+','+toLng+'&travelmode=driving';
    }
    function gmapsLinkByName(name){ return 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(name); }
    function toRad(v){ return v*Math.PI/180; }
    function haversine(a,b,c,d){const R=6371;const dL=toRad(c-a), dG=toRad(d-b);const A=Math.sin(dL/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dG/2)**2;return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));}
    function findNearest(from){var best=null,bd=1e9; for(var i=0;i<FILTERED_CENTERS.length;i++){var c=FILTERED_CENTERS[i],d=haversine(from[0],from[1],c.lat,c.lng); if(d<bd){bd=d; best=c;}} return best;}

    function detectSector(name=''){
      const t=(name||'').trim();
      const pub=/(Ø§Ù„Ù…Ù„Ùƒ|Ø§Ù„ØªØ®ØµØµÙŠ|Ø§Ù„Ø¹Ø§Ù…|Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©|Ø§Ù„Ù‚ÙˆØ§Øª|Ø§Ù„Ø­Ø±Ø³|Ù…Ø¬Ù…Ø¹|Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ùƒ|Ø§Ù„Ø«ØºØ±|Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ©)/;
      const pri=/(Ø§Ù„Ø¯ÙƒØªÙˆØ±|ÙÙ‚ÙŠÙ‡|Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ|Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù…ØªØ­Ø¯ÙˆÙ†|Ø§Ù„Ø³Ù„Ø§Ù…Ø©|Ø§Ù„Ù…ØºØ±Ø¨ÙŠ|Ø§Ù„Ø­ÙŠØ§Ø©|Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø¯ÙˆÙ„ÙŠ|Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø¯ÙˆÙ„ÙŠ|Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ø§Ù„Ù…Ø§Ù†ÙŠ)/;
      if(pub.test(t)) return 'public'; if(pri.test(t)) return 'private'; return '';
    }

    function createPopupContent(c){
      var link=gmapsLinkByName(c.name);
      var phone=c.phone?('<p><strong>ğŸ“</strong> <a href="tel:'+c.phone+'" style="color:#0b7dda">'+c.phone+'</a></p>'):'<p><strong>ğŸ“</strong> â€”</p>';
      var hours='<p><strong>â±ï¸</strong> '+(c.hours||'â€”')+'</p>';
      return '<div class="hospital-popup">'+
        '<strong><i class="fas fa-hospital"></i> '+c.name+'</strong>'+
        '<p><strong>ğŸ“</strong> '+(c.address||'â€”')+'</p>'+
        hours+phone+
        '<a class="go-map-btn" href="'+link+'" target="_blank" rel="noopener"><i class="fas fa-route"></i> Ø§Ø¶ØºØ· Ù„Ù„ØªÙˆØ¬ÙŠÙ‡</a>'+
      '</div>';
    }

    var map=L.map('mapid').setView([JEDDAH_LAT,JEDDAH_LNG],DEFAULT_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap contributors'}).addTo(map);
    var redMarker=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});
    var blueMarker=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});

    function renderCenters(list){
      if(markersLayer){markersLayer.clearLayers(); map.removeLayer(markersLayer);}
      markersLayer=L.layerGroup();
      (list||[]).forEach(function(c){ L.marker([c.lat,c.lng],{icon:redMarker}).bindPopup(createPopupContent(c)).addTo(markersLayer); });
      markersLayer.addTo(map);
      document.getElementById('map-counter').textContent = list.length ? (list.length+' Ù†ØªÙŠØ¬Ø©') : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬';
    }

    fetch('/static/centers_jeddah.json').then(r=>r.json()).then(list=>{
      BLOOD_CENTERS=list.map(c=>{ if(!c.sector) c.sector=(c.type||detectSector(c.name)); return c; });
      FILTERED_CENTERS=BLOOD_CENTERS.slice(); renderCenters(FILTERED_CENTERS);
    }).catch(()=>displayError('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ².'));

    document.getElementById('locate-center-btn').addEventListener('click', function(){
      var btn=this; btn.disabled=true; btn.querySelector('.label').innerText='Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...';
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){
          userLocation=[pos.coords.latitude,pos.coords.longitude];
          L.marker(userLocation,{icon:blueMarker}).addTo(map).bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ').openPopup();
          map.setView(userLocation,13);
          btn.querySelector('.label').innerText='ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­'; btn.disabled=false;
          displayMessage('ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ.','bot');
        }, function(){
          btn.querySelector('.label').innerText='ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'; btn.disabled=false;
          displayError('âš ï¸ Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.');
        }, {enableHighAccuracy:true,timeout:10000});
      } else { btn.querySelector('.label').innerText='ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…'; btn.disabled=false; displayError('âŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'); }
    });

    function openNearestAuto(){
      function go(lat,lng){
        if(!FILTERED_CENTERS.length){ displayError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§ÙƒØ² Ù…Ø·Ø§Ø¨Ù‚Ø©.'); return; }
        var n=findNearest([lat,lng]); if(!n) return;
        window.location.href = gmapsDirections(lat,lng,n.lat,n.lng);
      }
      if(userLocation) return go(userLocation[0],userLocation[1]);
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>go(p.coords.latitude,p.coords.longitude),
          ()=>displayError('Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù‚Ø±Ø¨ Ù…Ø±ÙƒØ².'), {enableHighAccuracy:true,timeout:8000});
      }
    }
    document.getElementById('map-nearest').addEventListener('click', openNearestAuto);

    function normalize(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
    function applyMapFilters(){
      const q=normalize(document.getElementById('map-search').value);
      const sector=document.getElementById('map-sector').value;
      FILTERED_CENTERS=BLOOD_CENTERS.filter(c=>{
        const hay=normalize((c.name||'')+' '+(c.address||'')); const matchText=!q || hay.indexOf(q)!==-1;
        const s=(c.sector||'').toLowerCase(); const matchSector=!sector || s===sector; return matchText && matchSector;
      });
      renderCenters(FILTERED_CENTERS);
      if(FILTERED_CENTERS.length){
        const avgLat=FILTERED_CENTERS.reduce((a,c)=>a+c.lat,0)/FILTERED_CENTERS.length;
        const avgLng=FILTERED_CENTERS.reduce((a,c)=>a+c.lng,0)/FILTERED_CENTERS.length;
        map.setView([avgLat,avgLng],12);
      }
    }
    document.getElementById('map-apply').addEventListener('click', applyMapFilters);
    document.getElementById('map-reset').addEventListener('click', ()=>{document.getElementById('map-search').value='';document.getElementById('map-sector').value='';FILTERED_CENTERS=BLOOD_CENTERS.slice();renderCenters(FILTERED_CENTERS);map.setView([JEDDAH_LAT,JEDDAH_LNG],DEFAULT_ZOOM);});
    document.getElementById('map-search').addEventListener('keydown', e=>{if(e.key==='Enter'){applyMapFilters();}});

    /* ===== 5) Ø§Ù„Ø´Ø§Øª ===== */
    var lastUserRaw='';
    document.getElementById('user-input').addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('send-btn').click(); }});
    document.getElementById('send-btn').addEventListener('click', async function(){
      var f=document.getElementById('user-input'); var raw=(f.value||'').trim(); if(!raw) return; f.value=''; lastUserRaw=raw;
      var Ld=null, data=null;
      try{
        setInteractionState(false); Ld=showLoading();
        var res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:raw})});
        if(!res.ok) throw new Error('HTTP '+res.status); data=await res.json();
      }catch(e){ displayError('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….'); removeLoading(Ld); setInteractionState(true); return; }
      finally{ removeLoading(Ld); setInteractionState(true); }
      if(data){ var finalUser=data.corrected_message||raw; displayMessage(finalUser,'user'); displayAnswerWithControls(data.answer||'',finalUser); if(isLocationIntent(raw)) openNearestAuto(); }
    });

    /* ===== 6) Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ ===== */
    document.getElementById('urgent-needs-btn').addEventListener('click', async function(){
      displayMessage('Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„ Ù„Ù„Ø¯Ù…','user');
      try{
        const r=await fetch('/api/urgent_needs'); const d=await r.json();
        const cb=document.getElementById('chat-box'); const w=document.createElement('div'); w.className='message bot-message';
        let html='<div><strong>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© Ù„Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…</strong></div><div class="urgent-needs-wrapper">';
        (d.needs||[]).forEach(n=>{
          var st=n.status||''; var cls=/Ø¬Ø¯Ø§Ù‹|critical/i.test(st)?'critical':(/Ø¹Ø§Ø¬Ù„|urgent/i.test(st)?'high':'low');
          var link=n.location_url?('<p><a class="go-map-btn" href="'+n.location_url+'" target="_blank" rel="noopener">Ø§Ø¶ØºØ· Ù„Ù„ØªÙˆØ¬ÙŠÙ‡</a></p>'):'';
          html+='<div class="urgent-card '+cls+'"><strong><i class="fas fa-hospital"></i> '+(n.hospital||'')+'</strong><p>ğŸ’¬ '+(n.details||'-')+'</p>'+link+'<span class="status">'+st+'</span></div>';
        });
        html+='</div>'; w.innerHTML=html; cb.appendChild(w); cb.scrollTop=cb.scrollHeight;
      }catch(e){ displayError('âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¹Ø§Ø¬Ù„.'); }
    });

    /* ===== 7) ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ© ===== */
    function ynField(id,label){
      return '<div style="margin-top:10px"><label>'+label+'</label>'+
        '<div class="yn-group" data-id="'+id+'">'+
        '<button type="button" class="helper-btn" data-val="true">Ù†Ø¹Ù…</button>'+
        '<button type="button" class="helper-btn" data-val="false">Ù„Ø§</button>'+
        '</div></div>';
    }
    function getYN(root,id){
      var grp=root.querySelector('.yn-group[data-id="'+id+'"]'); if(!grp) return false;
      var act=grp.querySelector('.helper-btn.active'); return act ? (act.getAttribute('data-val')==='true') : false;
    }
    function renderEligibilityForm(){
      var cb=document.getElementById('chat-box'); var card=document.createElement('div'); card.className='message bot-message';
      var html='<div><strong>ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ© Ù„Ù„ØªØ¨Ø±Ø¹</strong></div><div class="inline-note">Ø§Ø®ØªØ± Ù†Ø¹Ù…/Ù„Ø§ Ø¨ÙˆØ¶ÙˆØ­ØŒ Ø«Ù… Ø§Ø¶ØºØ· Â«Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Â».</div>';
      html+='<div style="margin-top:10px"><label>Ø§Ù„Ø¬Ù†Ø³</label><select id="elig-gender" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;margin-top:6px"><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option><option value="other">Ø¢Ø®Ø±</option></select></div>';
      html+='<div style="margin-top:10px"><label>Ø§Ù„Ø¹Ù…Ø±</label><input id="elig-age" type="number" min="1" max="100" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;margin-top:6px"/></div>';
      html+='<div style="margin-top:10px"><label>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="elig-weight" type="number" min="30" max="300" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;margin-top:6px"/></div>';
      html+='<div style="margin-top:10px"><label>Ù…ØªÙ‰ ÙƒØ§Ù† Ø¢Ø®Ø± ØªØ¨Ø±Ø¹ Ù„ÙƒØŸ (Ø¨Ø§Ù„Ø£ÙŠØ§Ù…)</label><input id="elig-last" type="number" min="0" max="2000" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;margin-top:6px"/></div>';

      html+=ynField('on_anticoagulants','Ù‡Ù„ ØªØªÙ†Ø§ÙˆÙ„ Ø£Ø¯ÙˆÙŠØ© Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ø¯Ù… Ø§Ù„Ø¢Ù†ØŸ');
      html+=ynField('on_antibiotics','Ù‡Ù„ ØªØªÙ†Ø§ÙˆÙ„ Ù…Ø¶Ø§Ø¯Ù‹Ø§ Ø­ÙŠÙˆÙŠÙ‹Ø§ Ù„Ø¹Ø¯ÙˆÙ‰ Ù†Ø´Ø·Ø©ØŸ');
      html+=ynField('has_cold','Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø£Ø¹Ø±Ø§Ø¶ Ø²ÙƒØ§Ù…/Ø­Ù…Ù‰ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŸ');

      html+='<div id="female-only">';
      html+=ynField('pregnant','Ù‡Ù„ Ø£Ù†ØªÙ Ø­Ø§Ù…Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŸ');
      html+=ynField('breastfeeding','Ù‡Ù„ Ø£Ù†ØªÙ Ù…Ø±Ø¶Ø¹Ø©ØŸ');
      html+='</div>';

      html+='<div style="margin-top:10px"><label>Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø±Ø§Ø­ÙŠ/Ù‚Ù„Ø¹ Ø£Ø³Ù†Ø§Ù†: ÙƒÙ… ÙŠÙˆÙ… Ù…Ø¶Ù‰ØŸ</label><input id="elig-proc" type="number" min="0" max="400" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;margin-top:6px"/></div>';
      html+='<div style="margin-top:10px"><label>ÙˆØ´Ù…/Ø«Ù‚Ø¨ Ø®Ù„Ø§Ù„ ÙƒÙ… Ø´Ù‡Ø± Ù…Ø¶Ù‰ØŸ</label><input id="elig-tattoo" type="number" min="0" max="48" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;margin-top:6px"/></div>';
      html+=ynField('recent_travel','Ù‡Ù„ Ø³Ø§ÙØ±Øª Ù…Ø¤Ø®Ø±Ù‹Ø§ Ù„Ù…Ù†Ø§Ø·Ù‚ Ù…ÙˆØ¨ÙˆØ¡Ø© Ø£Ùˆ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù…Ù„ÙƒØ©ØŸ');

      html+='<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">'+
              '<button id="elig-submit" class="helper-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>'+
            '</div>';
      card.innerHTML=html; cb.appendChild(card); cb.scrollTop=cb.scrollHeight;

      function toggleFemale(){
        var g=card.querySelector('#elig-gender').value;
        card.querySelector('#female-only').style.display = (g==='female') ? 'block' : 'none';
      }
      card.querySelector('#elig-gender').addEventListener('change', toggleFemale); toggleFemale();

      card.querySelectorAll('.yn-group .helper-btn').forEach(function(b){
        b.addEventListener('click', function(){
          var all=this.parentElement.querySelectorAll('.helper-btn'); all.forEach(x=>x.classList.remove('active'));
          this.classList.add('active');
        });
      });

      card.querySelector('#elig-submit').addEventListener('click', async function(){
        var payload={
          gender: card.querySelector('#elig-gender').value,
          age: Number(card.querySelector('#elig-age').value||0),
          weight: Number(card.querySelector('#elig-weight').value||0),
          last_donation_days: Number(card.querySelector('#elig-last').value||9999),
          on_anticoagulants: getYN(card,'on_anticoagulants'),
          on_antibiotics: getYN(card,'on_antibiotics'),
          has_cold: getYN(card,'has_cold'),
          pregnant: getYN(card,'pregnant'),
          breastfeeding: getYN(card,'breastfeeding'),
          recent_procedure_days: Number(card.querySelector('#elig-proc').value||9999),
          tattoo_months: Number(card.querySelector('#elig-tattoo').value||999),
          recent_travel: getYN(card,'recent_travel')
        };
        try{
          const Ld=showLoading();
          const r=await fetch('/api/eligibility/evaluate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const d=await r.json(); removeLoading(Ld);
          var res='<div>'+ (d.eligible?'âœ… Ù…Ø¤Ù‡Ù„':'âŒ ØºÙŠØ± Ù…Ø¤Ù‡Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§') +'</div>';
          if(!d.eligible && (d.reasons||[]).length){
            res+='<ul>'+ (d.reasons||[]).map(x=>'<li>'+x+'</li>').join('') +'</ul>';
          }
          if(d.next_eligible_date){
            res+='<div class="inline-note">ğŸ“… Ù…ÙˆØ¹Ø¯Ùƒ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ù‚Ø§Ø¯Ù…: <strong>'+d.next_eligible_date+'</strong></div>';
            res+='<div style="margin-top:8px"><button id="add-rem-btn" class="helper-btn">Ø£Ø±Ø³Ù„ ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</button></div>';
          }
          displayMessage(res,'bot');

          setTimeout(function(){
            var btn=[...document.querySelectorAll('.helper-btn')].find(x=>x.id==='add-rem-btn');
            if(btn){
              btn.onclick=async function(){
                const email = prompt('Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ±:');
                if(!email){ displayError('Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯.'); return; }
                try{
                  const rr=await fetch('/api/reminder/email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email,next_date:d.next_eligible_date})});
                  const jj=await rr.json();
                  if(jj.ok) displayMessage('ğŸ“§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¹Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ.','bot');
                  else displayError('ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯: '+(jj.error||'')); 
                }catch(e){ displayError('ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯.'); }
              }
            }
          }, 50);

        }catch(e){ displayError('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©.'); }
      });
    }
    document.getElementById('eligibility-flow-btn').addEventListener('click', renderEligibilityForm);

    /* ===== 8) ØªØ°ÙƒÙŠØ± Ø³Ø±ÙŠØ¹ Ø²Ø± Ù…Ø³ØªÙ‚Ù„ ===== */
    document.getElementById('reminder-btn').addEventListener('click', async function(){
      const who=prompt('Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):')||'User';
      try{
        const r=await fetch('/api/reminder',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_hint:who,channel:'email'})});
        const j=await r.json();
        if(!j.ok){ displayError('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ±.'); return; }
        const email=prompt('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ±:');
        if(email){
          const rr=await fetch('/api/reminder/email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ email: email, next_date: j.next_date })});
          const jj=await rr.json();
          if(jj.ok){
            displayMessage('ğŸ“§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¹Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ.','bot');
          }else{
            displayError('ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯: '+(jj.error||''));
          }
        }else{
          displayError('Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯.');
        }
      }catch(e){
        displayError('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ°ÙƒÙŠØ±.');
      }
    });

    /* ===== 9) FAQ Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹ ===== */
    window.sendQuickQuestion = function(q){
      var f = document.getElementById('user-input');
      f.value = q;
      document.getElementById('send-btn').click();
    };
  </script>
</body>
</html>
